<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Plugins.MRI.MRI_PIQT.QCMR_lib &mdash; ..  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="..  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for Plugins.MRI.MRI_PIQT.QCMR_lib</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Wed Oct  9 08:50:51 2013</span>

<span class="sd">@author: aschilha</span>

<span class="sd">Warning: THIS MODULE EXPECTS PYQTGRAPH DATA: X AND Y ARE TRANSPOSED! And make sure rescaling is corrected!</span>

<span class="sd">TODO: Linearity : m/p angle</span>
<span class="sd">TODO: SliceProfile, uitzoeken of integral slice profile met of zonder lo correctie</span>
<span class="sd">TODO: MTF, pixelsizes</span>
<span class="sd">Changelog:</span>
<span class="sd">    20150629: Added feedback if MTF failed because of wrongly position phantom</span>
<span class="sd">    20150413: Gaussian fit with offset; fixed negative slice profile for Mxy</span>
<span class="sd">    20150204: Fixed missing SliceThickness for EnhancedDicom</span>
<span class="sd">    20141009: Moved strings for dicomModes to wadwrapper_lib</span>
<span class="sd">    20140930: Now also for enhanced DICOM; all DICOM read through wadwrapper_lib</span>
<span class="sd">    20140905: Force usage of Ramp for FWHM measurement (seems to be the case for MR8), regardless of slicethickness</span>
<span class="sd">    20140904: Fix for ImageSliceNumber; sending to dcm4chee changes some tags, and can add unexpected spaces.</span>
<span class="sd">    20140528: Initialize all items of PiQTStruct in __init__ (bug for gui)</span>
<span class="sd">    20140523: Fixed MTF and PhaseShift; removed global dcmFile, pixelData</span>
<span class="sd">    20140205: MTF implemented. Not correct result for pixelsizes (zeroes between left/right peak, or on right side of peak); possible mismatch angle (fixed 11.3 does better!)</span>
<span class="sd">    20140204: Correct slice number calculation; SP phantom shift and rotation and ramp angle; rescale images (done in GUI! but remember!); some phaseshift guestimate</span>
<span class="sd">    20131014: Corrected Slice Profile calculations (now using Schneiders1980)</span>
<span class="sd">    20131012: Finished Slice Profile</span>
<span class="sd">    20131011: Finished Linearity</span>
<span class="sd">    20131010: FFU calc of rad10 and rad20 by Euclidean distance transform</span>
<span class="sd">    20131009: Finished SNR; finished ArtLevel; finish FloodField Uniformity</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">dicom</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="kn">as</span> <span class="nn">scind</span>
<span class="kn">import</span> <span class="nn">QCMR_constants</span> <span class="kn">as</span> <span class="nn">lit</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">QCMR_math</span> <span class="kn">as</span> <span class="nn">mymath</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">wadwrapper_lib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyWADLib</span> <span class="kn">import</span> <span class="n">wadwrapper_lib</span>

<div class="viewcode-block" id="PiQT_Struct"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_Struct">[docs]</a><span class="k">class</span> <span class="nc">PiQT_Struct</span><span class="p">:</span>
    <span class="c"># input image</span>
    <span class="n">dcmInfile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pixeldataIn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">piqttest</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># tuple (seq_test,imagetype,philipsslicenumber,echonumber,echotime,)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">dicomMode</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span>
    <span class="n">scanID</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>

    <span class="c"># for matlib plotting</span>
    <span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="c"># SNR </span>
    <span class="n">snr_means</span>  <span class="o">=</span> <span class="p">[]</span> <span class="c"># average in Center, Background</span>
    <span class="n">snr_stdevs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stdev in Center, Background</span>
    <span class="n">snr_rois</span>   <span class="o">=</span> <span class="p">[]</span> <span class="c"># xy roi definitions # format: x0,wid, yo,hei</span>
    <span class="n">snr_slice</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">snr_SNC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">snr_SNB</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">snr_BsdB</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># Artefact Level </span>
    <span class="n">artefact_max</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Maximum mean value of ROI of 3*3 pixels in background of image. The edges of the image are masked.</span>
    <span class="n">artefact_roi</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># x0,y0,rad</span>
    <span class="n">artefact_ArtLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c"># FloodField Uniformity</span>
    <span class="n">ffu_Ntot</span>     <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ffu_TCm20</span>    <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_Cm20Cm10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_Cm10Cp10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_Cp10Cp20</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_Cp20MAX</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_rad10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_rad20</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ffu_mid10</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting format [x,y]</span>
    <span class="n">ffu_mid20</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting format [x,y]</span>
    <span class="n">ffu_lin_unif</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ffu_mid_linunif</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting format [x,y]</span>
    <span class="n">ffu_rad_linunif</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="c"># for plotting format rad</span>

    <span class="c"># Spatial Linearity</span>
    <span class="n">lin_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lin_posgt</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c"># for plotting format [x,y]</span>
    <span class="n">lin_posfound</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># for plotting format [x,y]</span>
    <span class="n">lin_diampx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>   <span class="c"># for plotting format [x,y]</span>
    <span class="n">lin_phantomrotdeg</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># phantom misalignment</span>
    <span class="n">lin_phantomshift</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_sizehor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lin_sizever</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lin_intshiftavg</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># shifts</span>
    <span class="n">lin_intshiftsdev</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_shiftmax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_shiftmin</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_intdiffavg</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># linear differentials</span>
    <span class="n">lin_intdiffsdev</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">lin_intdiffmax</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">lin_intdiffmin</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">lin_nema_label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_nema</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lin_nema_max</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c"># Slice Profile</span>
    <span class="n">sp_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">sp_rois</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># for plotting</span>
    <span class="n">sp_mean</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># for plotting ?</span>
    <span class="n">sp_diamm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># for plotting </span>
    <span class="n">sp_pins</span>  <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting</span>
    <span class="n">sp_phantomrotdeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">sp_fwhm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sp_fwtm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># in mm</span>
    <span class="n">sp_phantomzangledeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">sp_line_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># in mm</span>
    <span class="n">sp_phantom</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">sp_method</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">sp_slicewidth_fwhm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT fwhm but FWHM*tan(angle)</span>
    <span class="n">sp_slicewidth_fwtm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT fwtm but FWTM*tan(angle)</span>
    <span class="n">sp_slicewidth_lineint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT line_int but line_int*tan(angle),</span>
                               <span class="c"># also non-zero offset correction and scaled by (hival-loval) so it is like SW</span>
    <span class="n">sp_phantomshift</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># philips Distance between centre of slice thickness section to the centre of image plane, but can be negative?</span>
    <span class="n">sp_phaseshift</span> <span class="o">=</span> <span class="o">-</span><span class="mf">360.</span> <span class="c"># phaseshift in degrees. Don&#39;t know if this is calculated properly</span>

    <span class="c"># MTF</span>
    <span class="n">mtf_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mtf_rois</span>  <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting</span>
    <span class="n">mtf_pixelsize</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mtf_mtf50</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mtf_integral</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">lastimage</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># container for last calculated image</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dcmInfile</span><span class="p">,</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="n">dicomMode</span><span class="p">,</span><span class="n">piqttest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="o">=</span> <span class="n">dcmInfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">pixeldataIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">=</span> <span class="n">dicomMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanID</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piqttest</span> <span class="o">=</span> <span class="n">piqttest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_means</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_stdevs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_SNC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_SNB</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_BsdB</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artefact_max</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artefact_roi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artefact_ArtLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_Ntot</span>     <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_TCm20</span>    <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_Cm20Cm10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_Cm10Cp10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_Cp10Cp20</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_Cp20MAX</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_rad10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_rad20</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_mid10</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_mid20</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_lin_unif</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_mid_linunif</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting format [x,y]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffu_rad_linunif</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="c"># for plotting format rad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_posgt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_posfound</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_diampx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_phantomrotdeg</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># phantom misalignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_phantomshift</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_sizehor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_sizever</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intshiftavg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intshiftsdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_shiftmax</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># geom. shifts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_shiftmin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intdiffavg</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># linear differentials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intdiffsdev</span> <span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intdiffmax</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_intdiffmin</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_nema_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_nema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_nema_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_rois</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_mean</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># for plotting ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_diamm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># for plotting </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_pins</span>  <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_phantomrotdeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_fwhm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_fwtm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># in mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_phantomzangledeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_line_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># in mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_phantom</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_method</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_slicewidth_fwhm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT fwhm but FWHM*tan(angle)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_slicewidth_fwtm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT fwtm but FWHM*tan(angle)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_slicewidth_lineint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># philips PiQT report values are NOT line_int but line_int*tan(angle),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_phantomshift</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># philips Distance between centre of slice thickness section to the centre of image plane, but can be negative?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_phaseshift</span> <span class="o">=</span> <span class="o">-</span><span class="mf">360.</span> <span class="c"># phaseshift in degrees. Don&#39;t know if this is calculated properly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_rois</span>  <span class="o">=</span> <span class="p">[]</span> <span class="c"># for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_pixelsize</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_mtf50</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_integral</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="PiQT_QC"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC">[docs]</a><span class="k">class</span> <span class="nc">PiQT_QC</span><span class="p">:</span>
    <span class="n">qcversion</span> <span class="o">=</span> <span class="mi">20150629</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    string constants</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ** head and body coils</span>
<span class="sd">        The parameters used are:</span>
<span class="sd">        ROI size to calculate C:    30 * 30 pixels</span>
<span class="sd">        ROI pos. to calculate C:    centre of image for body phantoms and for transverse head phantoms.</span>
<span class="sd">        ROI used for sd(B):         40 * 10 pixels at corner of FOV.</span>
<span class="sd">        histogram ROI:              FOV</span>
<span class="sd">        number of steps, N:         2 (5 grey levels)</span>
<span class="sd">        percentage, S:              10%</span>
<span class="sd">        threshold value:            10 * B (Ntot = number of pixels within phantom)</span>
<span class="sd">        names percentage ratios:    T/C-20, C-20/C-10, C-10/C+10, C+10/C+20, C+20/MAX</span>
<span class="sd">        radius percentages:         10%, 20%</span>

<span class="sd">        Notes:</span>
<span class="sd">        1) The histogram values are obtained from the image after applying a filter to reduce noise influences.</span>
<span class="sd">        2) The centre ROI is shifted 50mm upwards in case of sagittal and coronal head phantom images, to minimize the effect of mirroring.</span>
<span class="sd">        3) Analysis is not allowed on images with a pixel resolution of less than 12bits/pixel since this would result to incomparable values.</span>
<span class="sd">    &quot;&quot;&quot;</span>        
<span class="c">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="PiQT_QC.readDICOMtag"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.readDICOMtag">[docs]</a>    <span class="k">def</span> <span class="nf">readDICOMtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">imslice</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c"># slice=2 is image 3</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="p">,</span><span class="n">imslice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

</div>
<div class="viewcode-block" id="PiQT_QC.pix2phantommm"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.pix2phantommm">[docs]</a>    <span class="k">def</span> <span class="nf">pix2phantommm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode3D</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pix</span><span class="o">*</span><span class="n">pix2mmm</span>
</div>
<div class="viewcode-block" id="PiQT_QC.phantommm2pix"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.phantommm2pix">[docs]</a>    <span class="k">def</span> <span class="nf">phantommm2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">mm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode3D</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pix2mmm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">mm</span><span class="o">/</span><span class="n">pix2mmm</span>
<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="PiQT_QC.CoilType"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.CoilType">[docs]</a>    <span class="k">def</span> <span class="nf">CoilType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">imslice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PiQT always uses Head Coil, but for completeness sake</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="n">dicomvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="s">&quot;0018,1250&quot;</span><span class="p">,</span><span class="n">imslice</span><span class="p">)</span> <span class="c"># Receive Coil Name</span>
        <span class="n">dicomvalue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dicomvalue</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;BODY&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilBody</span>
        <span class="k">elif</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;HEAD&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;MULTI&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span> <span class="c"># multi coil means both, but we only check for non_surface</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilHead</span>
        <span class="k">elif</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;SURFACE&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilSurface</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[CoilType]&quot;</span><span class="p">,</span><span class="n">dicomvalue</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="PiQT_QC.ImageSliceNumber"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.ImageSliceNumber">[docs]</a>    <span class="k">def</span> <span class="nf">ImageSliceNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">piqttest</span><span class="p">):</span> <span class="c">#seqname,imagetype,slice_number,echo_time,echo_num):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make index of slices by imagetype (M,R,I); echotime (15,30,50,100,150); echonumber (1,2,3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">(</span><span class="n">seqname</span><span class="p">,</span><span class="n">imagetype</span><span class="p">,</span><span class="n">slice_number</span><span class="p">,</span><span class="n">echo_num</span><span class="p">,</span><span class="n">echo_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">piqttest</span>
        <span class="n">dicomvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c">#&quot;Protocol Name&quot;],  # QA1S:MS,SE</span>
        <span class="n">_seqname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dicomvalue</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">seqid</span> <span class="o">=</span> <span class="n">seqname</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="c"># first 3 elements QA1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_seqname</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">seqid</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ImageSliceNumber: wrong sequence; </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">seqid</span><span class="p">,</span><span class="n">_seqname</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">&quot;2005,1011&quot;</span><span class="p">,</span> <span class="s">&quot;Image_Type&quot;</span><span class="p">],</span> <span class="c"># M,R,I</span>
		    <span class="p">[</span><span class="s">&quot;2001,100a&quot;</span><span class="p">,</span> <span class="s">&quot;Slice Number&quot;</span><span class="p">],</span> <span class="c"># Philips private, alternative is slice location/slice spacing</span>
            <span class="p">[</span><span class="s">&quot;0018,0086&quot;</span><span class="p">,</span> <span class="s">&quot;Echo_No&quot;</span><span class="p">],</span> <span class="c"># 1</span>
<span class="c">#		    [&quot;0018,0081&quot;, &quot;Echo_Time&quot;], # 50</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span><span class="p">:</span>
            <span class="n">dimz</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode3D</span><span class="p">:</span>
            <span class="n">dimz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">_datasets</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dimz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimz</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dicomfields</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">val</span><span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;_&quot;</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="c">#print seqname,val,i</span>

        <span class="n">lookup</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">imagetype</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">slice_number</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">echo_num</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_&quot;</span> <span class="c">#+str(echo_time)+&quot;_&quot;</span>
        <span class="k">if</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">indices</span><span class="p">[</span><span class="n">lookup</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="PiQT_QC.SliceProfile"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.SliceProfile">[docs]</a>    <span class="k">def</span> <span class="nf">SliceProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The slice profile is defined as the transverse magnetization as a function of the position</span>
<span class="sd">        in the selection direction. </span>
<span class="sd">        The slice profile is calculated from the image of the slice thickness section of the head</span>
<span class="sd">        phantom. This section has a double ramp with a width of 1mm and a wedge. The angle</span>
<span class="sd">        of the ramps and the wedge with respect to the image plane is 11.31 degrees.</span>

<span class="sd">        Two types of slice profile calculations are carried out:</span>
<span class="sd">            Modulus: This method calculates the slice profile from the modulus image.</span>
<span class="sd">                A profile across the ramp section or differentiation of a profile along the</span>
<span class="sd">                wedge yields the slice profile. To increase the SNR of the calculated slice</span>
<span class="sd">                profile a number of profiles are averaged.</span>
<span class="sd">            MXY: This method is similar to the above.</span>
<span class="sd">                The difference is that the averaging of profiles is performed in the real and</span>
<span class="sd">                imaginary image before the modulus is taken.</span>
<span class="sd">                The advantages are:</span>
<span class="sd">                    1) The edges of the slice profile are less disturbed due to backfolding of the</span>
<span class="sd">                    noise.</span>
<span class="sd">                    2) The phase of the magnetization in the selection direction can be determined.</span>

<span class="sd">        In order to characterize the slice profile a number of parameters are defined:</span>
<span class="sd">            FWHM: Full Width Half Maximum of slice profile.</span>
<span class="sd">            FWTM: Full Width at Tenth Maximum.</span>
<span class="sd">            Slice Integral : Integral of slice profile i.e. the energy stored in the slice.</span>
<span class="sd">            Phase shift: Phase difference in selection direction (only Mxy).</span>

<span class="sd">        This procedure consists of three steps:</span>
<span class="sd">            1. The in-plane rotation of the image (using the three pins) and the angle of the scan</span>
<span class="sd">            plane is determined with the phantom section (using the double ramp).</span>
<span class="sd">            2. Depending on the slice thickness the ramp or the wedge is selected:</span>
<span class="sd">                ramp : slice thickness &gt;= 5 mm</span>
<span class="sd">                wedge: slice thickness &lt; 5 mm</span>
<span class="sd">            3.The calculation method is selected, depending on the scan sequence:</span>
<span class="sd">                Mxy: SE and IR images</span>
<span class="sd">                modulus: FFE images</span>
<span class="sd">        NOTES:</span>
<span class="sd">        A. 1D linear phase correction should be applied for SE and IR scans.</span>
<span class="sd">        B. If &#39;Mxy&#39; method fails (e.g. if no imaginary or real images are present) the &#39;modulus&#39;</span>
<span class="sd">        method is selected automatically.</span>

<span class="sd">        The NEMA procedure is identical to the Philips quality procedure except that only</span>
<span class="sd">        &#39;modulus&#39; calculations are performed.</span>

<span class="sd">        Also phantom shift = Distance between centre of slice thickness section to the centre of image plane.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. Determine slice thickness -&gt; ramp (&gt;=5mm) or wedge</span>
<span class="sd">            2. Determine scan sequence -&gt; Mxy (SE,IR), Modulus (FFE)</span>
<span class="sd">            3. Determine in-plane rotation</span>
<span class="sd">            4. Determine angle of scan plane</span>
<span class="sd">            5. Position ROI and calculate stuff</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># 0. Setup</span>
        <span class="k">if</span> <span class="n">cs_mr</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SliceProfile] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c">## image sequence</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SliceProfile] ERROR: Test&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="o">.</span><span class="n">stTestSliceProfile</span><span class="p">,</span><span class="s">&quot;not available for given image&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c">## coiltype</span>
        <span class="n">coiltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoilType</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span> <span class="ow">or</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilSurface</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SliceProfile] ERROR: coiltype not recognized&quot;</span>
            <span class="k">return</span> <span class="n">error</span>
        
        <span class="c"># 1. Determine Ramp or Wedge</span>
        <span class="n">sp_object</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWedge</span>
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode3D</span><span class="p">:</span>
            <span class="n">slicethickmm</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">]</span><span class="o">.</span><span class="n">SliceThickness</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># enhanced DICOM</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slicethickmm</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">]</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SliceThickness</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">slicethickmm</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">][(</span><span class="s">&#39;2005&#39;</span><span class="p">,</span><span class="s">&#39;140f&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SliceThickness</span>

        <span class="k">if</span> <span class="n">slicethickmm</span> <span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">sp_object</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stRamp</span>
<span class="c"># AS: het blijkt dat bij nieuwe scanners (MR8) in elk geval toch de ramp wordt gebruikt, ookal is slicethickmm=2</span>
<span class="c">#   dus we forceren vanaf nu altijd Ramp!</span>
        <span class="n">sp_object</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stRamp</span>

        <span class="c"># 2. Determine Mxy or Modulus</span>
        <span class="n">sp_method</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stMxy</span>
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">==</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode3D</span><span class="p">:</span>
            <span class="n">scanningsequence</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">]</span><span class="o">.</span><span class="n">ScanningSequence</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="c">#enhanced DICOM</span>
            <span class="n">scanningsequence</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">][(</span><span class="mh">0x2005</span><span class="p">,</span> <span class="mh">0x140f</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ScanningSequence</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scanningsequence</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;FFE&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sp_method</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stModulus</span>

        <span class="k">if</span> <span class="n">sp_method</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stMxy</span><span class="p">:</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>
            <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R&quot;</span>
            <span class="n">piqttestR</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span>
            <span class="n">piqttestI</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span><span class="p">)</span>
            <span class="n">sp_sliceR</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">piqttestR</span><span class="p">)</span>
            <span class="n">sp_sliceI</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">piqttestI</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sp_sliceR</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">sp_sliceI</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">sp_method</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stModulus</span>
        <span class="k">print</span> <span class="s">&quot;**** Method = &quot;</span><span class="p">,</span><span class="n">sp_method</span><span class="p">,</span><span class="n">sp_object</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span><span class="p">,</span><span class="n">sp_sliceR</span><span class="p">,</span><span class="n">sp_sliceI</span>

        <span class="c"># 3. in-plane rotation from 3 pins</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Just like the discs in the Spatial Linearity: </span>
<span class="sd">            1. define groundtruth (3 pts)</span>
<span class="sd">            2. find best center (look for minimum!)</span>
<span class="sd">            3. affine transformation</span>
<span class="sd">            4. Find angle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># theoretical positions</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ymid</span> <span class="o">=</span> <span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">defdistmm</span> <span class="o">=</span> <span class="mf">40.</span>
        <span class="n">defdiamm</span>  <span class="o">=</span> <span class="mf">5.</span>

        <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdistmm</span><span class="p">)</span>
        <span class="n">pos_gt</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">dxy</span><span class="p">,</span><span class="n">ymid</span><span class="p">],[</span><span class="n">xmid</span><span class="p">,</span><span class="n">hei</span><span class="o">-</span><span class="n">dxy</span><span class="p">],[</span><span class="n">wid</span><span class="o">-</span><span class="n">dxy</span><span class="p">,</span><span class="n">ymid</span><span class="p">]]]</span> <span class="c"># Find center expects 2d array of coords</span>

        <span class="c"># real location starting from theoretical ones, acc 1/4 pixel</span>
        <span class="n">pos_found</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pos_gt</span><span class="p">)</span>
        <span class="n">error</span><span class="p">,</span><span class="n">pos_found</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">FindCenters2D</span><span class="p">(</span><span class="n">pos_found</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdistmm</span><span class="o">/</span><span class="mf">4.</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdiamm</span><span class="p">),</span><span class="n">minimod</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># find Affine transformation, between theoretical positions and real locations</span>
        <span class="n">trn</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">Affine_Fit</span><span class="p">(</span><span class="n">pos_gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rotdeg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.</span><span class="o">*</span><span class="p">(</span><span class="n">trn</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">while</span><span class="p">(</span><span class="n">rotdeg</span><span class="o">&gt;</span><span class="mf">90.</span><span class="p">):</span>
            <span class="n">rotdeg</span> <span class="o">-=</span> <span class="mi">90</span>
        <span class="k">while</span><span class="p">(</span><span class="n">rotdeg</span><span class="o">&lt;-</span><span class="mf">90.</span><span class="p">):</span>
            <span class="n">rotdeg</span> <span class="o">+=</span> <span class="mi">90</span>

        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantomshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span><span class="p">((</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
        <span class="c"># 4. angle of scan plane rotation from the double ramp</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate FWHM1 and FWHM2 for ramp1 and ramp2.</span>
<span class="sd">        For a ramp at angle t to plane, the slice thickness S = FWHM*tan(t)</span>
<span class="sd">        Schneiders, Med.Phys 8(4) 1981, p516:</span>
<span class="sd">            Ramp1 at angle t1 to plane, ramp2 at angle t2 to plane, plane at angle phi.</span>
<span class="sd">            F1 is FWHM measured for ramp1, F1 is FWHM measured for ramp2.</span>
<span class="sd">            Define R = 2*F1/(F1+F2)*tan(t1+t2)</span>
<span class="sd">            then phi = arctan[1/R*(+/- sqrt(1+F2/F1*R^2)-1)]-t1; use plus sign when t1+t2&lt;90 deg and otherwise minus</span>
<span class="sd">            </span>
<span class="sd">        Slice Integral : Integral of slice profile i.e. the energy stored in the slice.</span>
<span class="sd">        AS1: Kan niet kloppen, want Philips geeft waarde in mm voor integral</span>
<span class="sd">            waarschijnlijk som p(i)*dx, en dan delen door phi. Maar</span>
<span class="sd">            moet je hier corrigeren voor offset? 1/(phi-plo)*sum_i (p(i)-plo)*dx</span>
<span class="sd">        AS2: Lijkt erop dat alle slice profile waarden door Philips vertaald zijn naar afschatting van slice thickness</span>
<span class="sd">        Note that the wedge profile should be differentiated to get the slice profile</span>
<span class="sd">        Note that for Mxy first make rois and calculate line averages in both real and,</span>
<span class="sd">          imaginary, then calc modulus and continue to FWHM </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fwhm_mm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fwtm_mm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mean_mm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">trn</span><span class="o">.</span><span class="n">getShift</span><span class="p">()</span>
        <span class="c">## make sure we report a value between -45 and +45 degrees, and note that Philips rotates in the other direction</span>
        <span class="n">rotdeg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.</span><span class="o">*</span><span class="p">(</span><span class="n">trn</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rotdeg</span><span class="o">&gt;</span><span class="mf">45.</span><span class="p">:</span>
            <span class="n">rotdeg</span> <span class="o">-=</span> <span class="mi">90</span>
        <span class="k">while</span> <span class="n">rotdeg</span><span class="o">&lt;-</span><span class="mf">45.</span><span class="p">:</span>
            <span class="n">rotdeg</span> <span class="o">+=</span> <span class="mi">90</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantomrotdeg</span> <span class="o">=</span> <span class="n">rotdeg</span>

        <span class="n">h0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">7.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sp_object</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stRamp</span><span class="p">:</span>
            <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">dxy</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">-</span><span class="n">h0</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">h0</span><span class="p">])</span> <span class="c"># x0,wid, yo,hei</span>
            <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">dxy</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">-</span><span class="n">h0</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">h0</span><span class="p">])</span> <span class="c"># x0,wid, yo,hei</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">dxy</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">-</span><span class="n">h0</span><span class="o">+</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">h0</span><span class="p">])</span> <span class="c"># x0,wid, yo,hei</span>
           
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">hwid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">slicethickmm</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sp_method</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stMxy</span><span class="p">):</span>
                <span class="n">dataR</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">sp_sliceR</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="n">lineR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataR</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c"># average in y direction</span>
                <span class="n">dataI</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">sp_sliceI</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="n">lineI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataI</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c"># average in y direction</span>
                <span class="n">dataM</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="n">lineM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataM</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c"># average in y direction</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">phaseshift</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">rr</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">mm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lineR</span><span class="p">,</span><span class="n">lineI</span><span class="p">,</span><span class="n">lineM</span><span class="p">):</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="c">#if ii &gt; 15: # arbitrairy number</span>
                    <span class="n">phaseshift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">rr</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="p">)</span>
                    <span class="c">#print rr,ii,line[-1],mm,phaseshift[-1]</span>

                <span class="c"># blur line, find pos max, average phaseshift over pos_max +/- 3</span>
                <span class="n">line_sigma</span> <span class="o">=</span> <span class="mf">2.8</span> <span class="c"># dimensionless</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sp_object</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWedge</span><span class="p">):</span>
                    <span class="n">blur_line</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line_sigma</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blur_line</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line_sigma</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">line_maxid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">blur_line</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">blur_line</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">line_minid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">blur_line</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">blur_line</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">line_minid</span><span class="o">-</span><span class="n">blur_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">abs</span><span class="p">(</span><span class="n">line_maxid</span><span class="o">-</span><span class="n">blur_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span> <span class="c"># min or max close to center</span>
                    <span class="n">line_maxid</span> <span class="o">=</span> <span class="n">line_minid</span>
                <span class="k">if</span> <span class="mi">3</span><span class="o">&lt;</span><span class="n">line_maxid</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">blur_phaseshift</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">phaseshift</span><span class="p">,</span> <span class="n">line_sigma</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phaseshift</span> <span class="o">=</span> <span class="n">blur_phaseshift</span><span class="p">[</span><span class="n">line_maxid</span><span class="p">]</span>
                    <span class="k">print</span> <span class="s">&quot;phaseshift:&quot;</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phaseshift</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;phaseshift:&quot;</span><span class="p">,</span><span class="s">&quot;dunno&quot;</span>
                    <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phaseshift</span> <span class="o">=</span> <span class="o">-</span><span class="mf">360.</span>
                <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;PhaseShift Mxy&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lineR</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;real&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lineI</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;imag&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;mag&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c"># average in y direction</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sp_object</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWedge</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                The finite difference derivative suffers terribly from noise.</span>
<span class="sd">                The proper way is to take a Gaussian derivative, but this will have an effect</span>
<span class="sd">                on the FWHM measurement. Some experiments show that if the original shape is a</span>
<span class="sd">                block of width B, a blur with sigma &lt; B/8. will have neglible effect on FWHM</span>
<span class="sd">                However in this case the block will have a width B=0...</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c"># finite difference derivative</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">-</span><span class="n">line2</span>
                <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">line_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">1.</span><span class="p">))</span>
            <span class="c"># fit gaus to find center            </span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">error</span><span class="p">,</span><span class="n">fit</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">GaussianFit</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>

            <span class="n">mid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">mean_mm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">hival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">mid</span><span class="o">-</span><span class="n">hwid</span><span class="p">:</span><span class="n">mid</span><span class="o">+</span><span class="n">hwid</span><span class="p">])</span>
            <span class="n">loval</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">hwid</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">hwid</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)]))</span>
            <span class="c"># correct line integral for non-zero offset?</span>
            <span class="n">line_int</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">*</span><span class="n">loval</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">line_int</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">hival</span><span class="o">-</span><span class="n">loval</span><span class="p">)</span>
            <span class="c">### line_int[-1] /= hival</span>

            <span class="n">hval</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">loval</span><span class="o">+</span><span class="n">hival</span><span class="p">)</span>
            <span class="n">lpos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">hval</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">hval</span><span class="p">:</span>
                    <span class="n">lpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">hval</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">i</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">hval</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">hval</span><span class="p">:</span>
                    <span class="n">rpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">hval</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">i</span>
                    <span class="k">break</span>
            <span class="n">fwhm_mm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">rpos</span><span class="o">-</span><span class="n">lpos</span><span class="p">))</span>
<span class="c">#            if(sp_method == lit.stMxy):</span>
<span class="c">#                phaseshift = []</span>
<span class="c">#                for i in range(int(lpos+(rpos-lpos)/4),int(rpos-(rpos-lpos)/4)):</span>
<span class="c">#                    phaseshift.append(np.arctan(lineI[i]/lineR[i])/np.pi*180.)</span>
<span class="c">#                print &quot;phaseshift:&quot;,np.min(phaseshift),np.max(phaseshift),np.mean(phaseshift)</span>
            <span class="n">tval</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">loval</span><span class="o">+</span><span class="n">hival</span><span class="p">)</span>
            <span class="n">tlpos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">trpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">tval</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">tval</span><span class="p">):</span>
                    <span class="n">tlpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tval</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">i</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">tval</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">tval</span><span class="p">):</span>
                    <span class="n">trpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tval</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">i</span>
                    <span class="k">break</span>
            <span class="n">fwtm_mm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">trpos</span><span class="o">-</span><span class="n">tlpos</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="c"># plot</span>
                <span class="n">gs_fit</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">fit</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">gs_fit</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;gs fit&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">mid</span><span class="o">-</span><span class="n">hwid</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="n">mid</span><span class="o">+</span><span class="n">hwid</span><span class="p">]],[</span><span class="n">hival</span><span class="p">,</span><span class="n">hival</span><span class="p">])</span>           
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lpos</span><span class="p">,</span><span class="n">rpos</span><span class="p">],[</span><span class="n">hval</span><span class="p">,</span><span class="n">hval</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">tlpos</span><span class="p">,</span><span class="n">trpos</span><span class="p">],[</span><span class="n">tval</span><span class="p">,</span><span class="n">tval</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># gui stuff</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_rois</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rois</span><span class="p">)</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_mean</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mean_mm</span><span class="p">)</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_diamm</span> <span class="o">=</span> <span class="n">defdiamm</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_pins</span>  <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c"># Report values</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantomrotdeg</span> <span class="o">=</span> <span class="n">rotdeg</span>
        <span class="k">print</span> <span class="s">&quot;FWHMA!&quot;</span><span class="p">,</span><span class="n">fwhm_mm</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhm_mm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_fwhm</span> <span class="o">=</span> <span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_fwtm</span> <span class="o">=</span> <span class="n">fwtm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_line_int</span> <span class="o">=</span> <span class="n">line_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantomzrotdeg</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">F2</span> <span class="o">=</span> <span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">11.31</span><span class="o">/</span><span class="mf">180.</span>
            <span class="n">theta2</span> <span class="o">=</span> <span class="n">theta1</span>
            <span class="n">R</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">F1</span><span class="o">/</span><span class="p">(</span><span class="n">F1</span><span class="o">+</span><span class="n">F2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="o">+</span><span class="n">theta2</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span> <span class="mf">1.</span><span class="o">/</span><span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">F2</span><span class="o">/</span><span class="n">F1</span><span class="o">*</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">))</span> <span class="o">-</span><span class="n">theta1</span>
            
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_fwtm</span> <span class="o">=</span> <span class="p">[</span><span class="n">fwtm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fwtm_mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_line_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_int</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">line_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">zrotdeg</span><span class="o">=</span><span class="p">(</span><span class="mi">180</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="o">+</span><span class="n">theta1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantomzangledeg</span> <span class="o">=</span> <span class="n">zrotdeg</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slicewidth_fwhm</span> <span class="o">=</span> <span class="n">fwhm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="o">+</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slicewidth_fwtm</span> <span class="o">=</span> <span class="n">fwtm_mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="o">+</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_slicewidth_lineint</span> <span class="o">=</span> <span class="n">line_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="o">+</span><span class="n">phi</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;FWHMB!&quot;</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_fwhm</span>
        <span class="c"># slice width = inplane FWMH*tan theta</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_phantom</span> <span class="o">=</span> <span class="n">sp_object</span> 
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">sp_method</span> <span class="o">=</span> <span class="n">sp_method</span> 

<span class="c">#        dataR = self.pixeldataIn[sp_sliceR].astype(float)</span>
<span class="c">#        dataI = self.pixeldataIn[sp_sliceI].astype(float)</span>
<span class="c">#        cs_mr.lastimage = np.arctan(dataI/dataR) # phase!</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>

</div>
<div class="viewcode-block" id="PiQT_QC.MTF"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.MTF">[docs]</a>    <span class="k">def</span> <span class="nf">MTF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The Philips phantom for measuring spatial resolution is the &#39;square hole&#39; section of the</span>
<span class="sd">        head phantom. The procedure for evaluation of an image of this section is as follows:</span>
<span class="sd">            For the measurement and the preparation direction the Edge Response Function</span>
<span class="sd">                (ERF) is determined from the &#39;image&#39; of the edge of the square hole.</span>
<span class="sd">                Differentiation of the ERF&#39;s yield the Line Spread Functions (LSF) in the measure-</span>
<span class="sd">                ment and preparation directions.</span>
<span class="sd">            The MTF&#39;s in measurement and preparation directions are obtained by taking the</span>
<span class="sd">                Fourier Transforms of the LSF&#39;s.</span>
<span class="sd">        To characterize the LSF&#39;s and MTF&#39;s the following parameters are calculated for both the</span>
<span class="sd">        measurement and preparation direction:</span>
<span class="sd">            pixel size: Width between the two first zeros of the LSF.</span>
<span class="sd">            MTF_50: Full Width at Half Maximum, FWHM, expressed in line pairs per pixel.</span>
<span class="sd">                For an ideal system this value is 0.5.</span>
<span class="sd">            Integral: Integral of MTF between 0 and 0.5</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. Find phantom rotation</span>
<span class="sd">            2. Make ROIs and Calc EdgeSpreadFunction</span>
<span class="sd">            3. Do FFT</span>
<span class="sd">            4. Calc stuff</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># 0. Setup</span>
        <span class="k">if</span> <span class="n">cs_mr</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[MTF] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c">## image sequence</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[MTF] ERROR: Test&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="o">.</span><span class="n">stTestMTF</span><span class="p">,</span><span class="s">&quot;not available for given image&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1. Phantomrotation:</span>
<span class="sd">        1.a Make lines between edge and first half of phantom</span>
<span class="sd">        1.b Calculate number of phantom pixels in line (sum over line - N*bk)/sig</span>
<span class="sd">        1.c Fit line to slopes</span>
<span class="sd">        1.d Best fit of four sides gives rotation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># theoretical positions</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span>   <span class="o">=</span> <span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ymid</span>   <span class="o">=</span> <span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">diampx</span> <span class="o">=</span> <span class="n">wid</span><span class="o">/</span><span class="mi">3</span>
        <span class="n">radsig</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">])</span> <span class="c"># bk  # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">-</span><span class="n">radsig</span><span class="p">),</span>  <span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">,</span>      <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">/</span><span class="mi">8</span><span class="o">+</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">radsig</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">])</span> <span class="c"># signal  # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">-</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="p">)])</span>   <span class="c"># VOI left half # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="p">),</span>         <span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="p">)])</span>   <span class="c"># VOI right half # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">-</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>   <span class="c"># VOI upper half # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">-</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hei</span><span class="o">/</span><span class="mi">8</span><span class="o">+</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>   <span class="c"># VOI lower half # x0,wid, y0,hei</span>
        <span class="c"># BK calc</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
        <span class="n">bk_mean</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">bk_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c"># Sig calc</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
        <span class="n">sig_mean</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sig_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c">#        print &quot;BK&quot;,bk_mean,bk_stdev</span>
<span class="c">#        print &quot;SIG&quot;,sig_mean,sig_stdev</span>

        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="c">#plt.figure()</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">phantomangle</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">best_r</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="n">pline</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">pline</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="n">bk_mean</span><span class="p">)</span><span class="o">/</span><span class="n">sig_mean</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                    <span class="n">pline</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="n">bk_mean</span><span class="p">)</span><span class="o">/</span><span class="n">sig_mean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pline</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">pline</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">pline</span><span class="p">))</span>
            <span class="n">fitline</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pline</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">minV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pline</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">ranV</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxV</span><span class="o">-</span><span class="n">minV</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pline</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">minV</span><span class="o">+</span><span class="n">ranV</span><span class="o">/</span><span class="mf">8.</span> <span class="ow">and</span> <span class="n">y</span><span class="o">&lt;</span><span class="n">maxV</span><span class="o">-</span><span class="n">ranV</span><span class="o">/</span><span class="mf">8.</span><span class="p">:</span>
                    <span class="n">fitline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pline</span><span class="p">)</span>
                <span class="c">#plt.plot(fitline)</span>
                <span class="c">#plt.show()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitline</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;[MTF] Cannot find EdgeObject! Rotated phantom?&quot;</span><span class="p">)</span>
            <span class="n">error</span><span class="p">,</span><span class="n">coef</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">LinearFit</span><span class="p">(</span><span class="n">fitline</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">best_r</span><span class="p">:</span>
                <span class="n">best_r</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">phantomangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c">#            print len(fitline),np.arctan(coef[0])/np.pi*180.,coef[2:]</span>
<span class="c">#        phantomangle = (90-11.3)/180.*np.pi</span>
        <span class="k">print</span> <span class="s">&quot;phantomangledeg&quot;</span><span class="p">,</span><span class="n">phantomangle</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span>

        <span class="c"># 2. make 2 MTF ROIs and calculated presampled MTFs</span>
        <span class="n">radsig</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">,</span>   <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span> <span class="c"># signal  # x0,wid, y0,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">diampx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">radsig</span><span class="p">])</span> <span class="c"># signal  # x0,wid, y0,hei</span>

        <span class="n">lineH</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lineV</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cosval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phantomangle</span><span class="p">)</span>
        <span class="n">doScaleMTF</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_rois</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doScaleMTF</span><span class="p">:</span>
                        <span class="n">hival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
                        <span class="n">loval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">loval</span> <span class="o">&gt;</span> <span class="n">hival</span><span class="p">:</span>
                            <span class="n">swapval</span> <span class="o">=</span> <span class="n">loval</span>
                            <span class="n">loval</span> <span class="o">=</span> <span class="n">hival</span>
                            <span class="n">hival</span> <span class="o">=</span> <span class="n">swapval</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">loval</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">hival</span><span class="o">-</span><span class="n">loval</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="n">lineH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">cosval</span><span class="p">,</span><span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_slice</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doScaleMTF</span><span class="p">:</span>
                        <span class="n">hival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
                        <span class="n">loval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">loval</span> <span class="o">&gt;</span> <span class="n">hival</span><span class="p">:</span>
                            <span class="n">swapval</span> <span class="o">=</span> <span class="n">loval</span>
                            <span class="n">loval</span> <span class="o">=</span> <span class="n">hival</span>
                            <span class="n">hival</span> <span class="o">=</span> <span class="n">swapval</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">loval</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">hival</span><span class="o">-</span><span class="n">loval</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="n">lineV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">cosval</span><span class="p">,</span><span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">lineH</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lineH</span><span class="p">)</span>
        <span class="n">lineV</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lineV</span><span class="p">)</span>
        <span class="c"># 3. 1D FFT</span>
        <span class="c"># interpolate</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_pixelsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_pixelsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MTFcalc</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">lineH</span><span class="p">,</span><span class="n">cosval</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">mtf_pixelsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MTFcalc</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">lineV</span><span class="p">,</span><span class="n">cosval</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<span class="c">##        self.EdgeDetection(self.pixeldataIn[cs_mr.mtf_slice])</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="PiQT_QC.MTFcalc"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.MTFcalc">[docs]</a>    <span class="k">def</span> <span class="nf">MTFcalc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">linedat</span><span class="p">,</span><span class="n">stepsize_in</span><span class="p">,</span><span class="n">verbose</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        <span class="n">stepsize</span> <span class="o">=</span> <span class="n">stepsize_in</span>

        <span class="c"># interpolate</span>
        <span class="n">xH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">linedat</span><span class="p">])</span>
        <span class="n">yH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">linedat</span><span class="p">])</span>
        <span class="n">hfun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xH</span><span class="p">,</span><span class="n">yH</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">hpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xH</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xH</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">stepsize</span><span class="p">)</span>
        <span class="n">esf</span> <span class="o">=</span> <span class="n">hfun</span><span class="p">(</span><span class="n">hpos</span><span class="p">)</span>
        <span class="n">doCenter</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">doCenter</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.8</span> <span class="c"># dimensionless</span>
            <span class="n">lsf</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">esf</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lsfmaxid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">lsf</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">lsf</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">)</span><span class="o">-</span><span class="n">lsfmaxid</span><span class="p">,</span><span class="n">lsfmaxid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">esf</span> <span class="o">=</span> <span class="n">esf</span><span class="p">[</span><span class="n">lsfmaxid</span><span class="o">-</span><span class="n">nums</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">lsfmaxid</span><span class="o">+</span><span class="n">nums</span><span class="p">]</span>
            <span class="n">hpos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">lsfmaxid</span><span class="o">-</span><span class="n">nums</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">lsfmaxid</span><span class="o">+</span><span class="n">nums</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;esf&quot;</span><span class="p">)</span>
            <span class="c">#plt.plot(xH,yH,&#39;b.&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span><span class="n">esf</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">)</span>

        <span class="c"># smooth ESF</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># moving average window width</span>
        <span class="c"># possibly better to just take Gaussian derivative with sigma = span</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ksize</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">/</span><span class="n">ksize</span>
        <span class="n">smoothed</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">esf</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">)</span>

        <span class="c"># differentiate</span>
        <span class="n">useGaussian</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useGaussian</span><span class="p">:</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">esf</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">esf</span><span class="o">-</span><span class="n">line2</span><span class="p">)</span>
            <span class="n">lsf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lsf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsf</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c"># dimensionless</span>
            <span class="n">lsf</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">esf</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># normalize LSF</span>
        <span class="n">lsf</span>  <span class="o">=</span> <span class="n">lsf</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lsf</span><span class="p">)</span>
        <span class="n">lsfmaxid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">lsf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">lsf</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lpos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lsfmaxid</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">lpos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">lpos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: lpos is None&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>

        <span class="n">l2pos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">((</span><span class="n">lpos</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">l2pos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">l2pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: l2pos is None&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>

        <span class="n">l3pos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">((</span><span class="n">l2pos</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">l3pos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">l3pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: l3pos is None&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>

        <span class="n">rpos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lsfmaxid</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">rpos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">rpos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: 3pos is None&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">rpos</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">r2pos</span> <span class="o">=</span> <span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lsf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hpos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="n">pixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">lpos</span><span class="o">-</span><span class="n">l3pos</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;pixsize=&quot;</span><span class="p">,</span><span class="n">pixsize</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">rpos</span><span class="o">-</span><span class="n">lpos</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">r2pos</span><span class="o">-</span><span class="n">rpos</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">l2pos</span><span class="o">-</span><span class="n">lpos</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">l3pos</span><span class="o">-</span><span class="n">l2pos</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;lsf&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span><span class="n">lsf</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">l3pos</span><span class="p">,</span><span class="n">l2pos</span><span class="p">,</span><span class="n">lpos</span><span class="p">,</span><span class="n">rpos</span><span class="p">,</span><span class="n">r2pos</span><span class="p">],[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="s">&#39;r.&#39;</span><span class="p">)</span>

        <span class="c"># take FFT</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">fft</span> <span class="k">as</span> <span class="n">fftpack</span>
        <span class="n">mtf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftpack</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">lsf</span><span class="p">))</span>
        <span class="c"># frequency axis</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">),</span> <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">stepsize</span><span class="p">))</span>
        <span class="n">mtf</span> <span class="o">=</span> <span class="n">mtf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">mtf</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">fnyq</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;MTF&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span><span class="n">mtf</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fnyq</span><span class="p">)</span>

        <span class="n">integral50</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">AreaUnderCurve</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span><span class="n">mtf</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">normalized</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mtf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mtf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mf">0.5</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">0.5</span><span class="p">:</span>
                <span class="n">mtf50</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">mtf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mtf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">print</span> <span class="s">&quot;mtf50/integral50&quot;</span><span class="p">,</span><span class="n">mtf50</span><span class="p">,</span><span class="n">integral50</span>

        <span class="k">return</span> <span class="n">pixsize</span>

</div>
<div class="viewcode-block" id="PiQT_QC.SNR"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.SNR">[docs]</a>    <span class="k">def</span> <span class="nf">SNR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The SNR is defined as: SNR = 0.655*R/sd(B) with,</span>
<span class="sd">        R: Mean pixel value of ROI at reference position.</span>
<span class="sd">        The reference position depends on the coil type.</span>
<span class="sd">        sd(B): Standard deviation of pixel values of ROI in a ghost-free part of the</span>
<span class="sd">        background of the image.</span>
<span class="sd">        0.655: Correction factor for backfolding of noise in background.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. determine sequence (this determines which imslice to use)</span>
<span class="sd">            2. determine body_head coil or surface coils</span>
<span class="sd">            3. define ROI</span>
<span class="sd">            4. calculate roi avgs and stdevs</span>
<span class="sd">            5. return all in structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">cs_mr</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SNR] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># 1. image sequence</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">seqname</span><span class="p">,</span><span class="n">imagetype</span><span class="p">,</span><span class="n">slice_number</span><span class="p">,</span><span class="n">echo_num</span><span class="p">,</span><span class="n">echo_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span>
            <span class="k">print</span> <span class="s">&quot;[SNR] ERROR: Test&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="o">.</span><span class="n">stTestUniformity</span><span class="p">,</span><span class="s">&quot;not available for given image&quot;</span><span class="p">,</span><span class="n">imagetype</span><span class="p">,</span><span class="n">echo_num</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># 2. coiltype</span>
        <span class="n">coiltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoilType</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span> <span class="ow">or</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilSurface</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SNR] ERROR: coiltype not recognized&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># 3. SNR</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_stdevs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">wid</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_rois</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># format: x0,wid, yo,hei</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">wid</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_rois</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_stdevs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="c"># report values</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_SNC</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_stdevs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_SNB</span> <span class="o">=</span> <span class="mf">0.655</span><span class="o">*</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_stdevs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_BsdB</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_stdevs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="PiQT_QC.ArtifactLevel"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.ArtifactLevel">[docs]</a>    <span class="k">def</span> <span class="nf">ArtifactLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The artifact level is defined as: artefact level = (G-B)*100/R % with,</span>
<span class="sd">        G: Maximum mean value of ROI of 3*3 pixels in background of image. The edges of the image are masked.</span>
<span class="sd">        B: Mean pixel value of ROI in ghost-free part of background.</span>
<span class="sd">        R: Mean pixel value of ROI at reference position. The reference position depends on the coil type.</span>

<span class="sd">        AS: Dit lijkt erg op NEMA Ghosting, maar daar wordt gedeeld door 2R. Als we dat hier</span>
<span class="sd">        ook doen, dan komt de waarde goed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. determine sequence (this determines which imslice to use)</span>
<span class="sd">            2. determine body_head coil or surface coils</span>
<span class="sd">            3. define ROIs</span>
<span class="sd">            4. calculate roi avgs and stdevs and in smoothed slice</span>
<span class="sd">            5. return all in structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNR</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[Artifact] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>


        <span class="c"># 3. Artifact</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c"># 3.1 moving average of image</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ksize</span><span class="p">,</span><span class="n">ksize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ksize</span><span class="o">*</span><span class="n">ksize</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">)</span>

        <span class="c"># 3.2 stay away from edges</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ksize</span><span class="p">:</span><span class="n">wid</span><span class="o">-</span><span class="n">ksize</span><span class="p">,</span><span class="n">ksize</span><span class="p">:</span><span class="n">wid</span><span class="o">-</span><span class="n">ksize</span><span class="p">]</span>

        <span class="c"># 3.3 select data outside circle only and stay away from circle edge</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">wid</span><span class="p">,</span> <span class="n">wid</span><span class="p">))</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">wid</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="mi">120</span> <span class="c"># dit is een gok. Minimaal 103+ksize, maar om ghosting buiten te sluiten meer. 128 is max</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">rad</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">cs_mr</span><span class="o">.</span><span class="n">artefact_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">artefact_roi</span> <span class="o">=</span> <span class="p">[</span><span class="n">mid</span><span class="o">+</span><span class="n">ksize</span><span class="p">,</span><span class="n">mid</span><span class="o">+</span><span class="n">ksize</span><span class="p">,</span><span class="n">rad</span><span class="p">]</span>

        <span class="c"># report value</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">artefact_ArtLevel</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">artefact_max</span><span class="o">-</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
        <span class="c">#print &quot;[ArtifactLevel] max&quot;,cs_mr.artefact_max</span>
        <span class="c">#plt.figure()</span>
        <span class="c">#data[mask] = 1500</span>
        <span class="c">#plt.imshow(data.transpose())</span>
        <span class="c">#cs_mr.hasmadeplots = True</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="PiQT_QC.FloodFieldUniformity"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.FloodFieldUniformity">[docs]</a>    <span class="k">def</span> <span class="nf">FloodFieldUniformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The procedure for the evaluation of floodfield uniformity consists of two steps:</span>
<span class="sd">        Step 1:</span>
<span class="sd">            A contour (&#39;grey scale&#39;) plot of the image is created as follows:</span>

<span class="sd">            1. The mean pixel values C (centre) and B (background),</span>
<span class="sd">                of ROI&#39;s at a reference position R are calculated.</span>
<span class="sd">                The reference position depends on the coil type.</span>
<span class="sd">            2. A grey value is assigned to every pixel using the following algorithm:</span>
<span class="sd">             For N=2: (Head and Body coils, and also Surface Coils?)</span>
<span class="sd">                T           &lt; pixel value &lt; C-N*S       black  T/C-20</span>
<span class="sd">                C-N*S       &lt; pixel value &lt; C-(N-1)*S   grey 1 C-20/C-10</span>
<span class="sd">                C-(N-1)*S   &lt; pixel value &lt; C+(N-1)*S   grey 2 C-10/C+10</span>
<span class="sd">                C+(N-1)*S   &lt; pixel value &lt; C+N*S       grey 3 C+10/C+20</span>
<span class="sd">                C+N*S       &lt; pixel value &lt; MAX         white  C+20/MAX</span>
<span class="sd">             For N=3: (Surface coils)</span>
<span class="sd">                T           &lt; pixel value &lt; C-N*S       black</span>
<span class="sd">                C-N*S       &lt; pixel value &lt; C-(N-1)*S   grey 1</span>
<span class="sd">                C-(N-1)*S   &lt; pixel value &lt; C-(N-2)*S   grey 2</span>
<span class="sd">                C-(N-2)*S   &lt; pixel value &lt; C+(N-2)*S   grey 3</span>
<span class="sd">                C+(N-2)*S   &lt; pixel value &lt; C+(N-1)*S   grey 4</span>
<span class="sd">                C+(N-1)*S   &lt; pixel value &lt; C+N*S       grey 5</span>
<span class="sd">                C+N*S       &lt; pixel value &lt; MAX         white</span>
<span class="sd">             with:</span>
<span class="sd">                 T: threshold value which is approximately 10*B</span>
<span class="sd">                 MAX: maximum pixel value</span>
<span class="sd">                 N: number of steps</span>
<span class="sd">                 S: step size = percentage*(C-B) 10% for Head and Body coils, 20% for Surface coils</span>
<span class="sd">                 2*N+1:number of contours, i.e. grey values</span>
<span class="sd">        Step 2:</span>
<span class="sd">            Because the shape of a contour plot can hardly be specified, a histogram calculation is</span>
<span class="sd">            performed to be able to specify floodfield uniformity.</span>

<span class="sd">            The histogram calculation proceeds as follows:</span>
<span class="sd">            1. A ROI (region of interest) for histogram calculation is defined:</span>
<span class="sd">                size and shape depends on the coil type.</span>
<span class="sd">            2. The number of pixels within the histogram ROI which have a pixel value larger than</span>
<span class="sd">                T, i.e. pixels which are not black, is determined: Ntot.</span>
<span class="sd">            3. For every grey value the percentage ratio is calculated:</span>
<span class="sd">                percentage ratio = &lt;number of pixels with a certain grey value&gt; / Ntot.</span>
<span class="sd">            4. The percentage ratio&#39;s are used to specify the floodfield uniformity.</span>

<span class="sd">        Notes:</span>
<span class="sd">        1) The histogram values are obtained from the image after applying a filter to re-</span>
<span class="sd">        duce noise influences.</span>

<span class="sd">        AS: Klopt niet. pv groter dan T is al black, dus 3 moet zijn at least black</span>
<span class="sd">        Waar het op neer komt is dat C-20/C-10 betekent: het percentage pixels met een waarde tussen C-20% en C-10%,</span>
<span class="sd">        waarbij alleen de pixels met een waarde groter dan T worden meegenomen</span>

<span class="sd">        rad_10%: Radius of the largest circle which fits in the C-10/C+10 area. grey2</span>
<span class="sd">        rad_20%: Radius of the largest circle which fits in the C-20/C+20 area. grey1+grey2+grey3</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. Find C and B</span>
<span class="sd">            2. Smooth image slice</span>
<span class="sd">            3. Calculate contourimage</span>
<span class="sd">            4. Calculate number of pixels in each &quot;contour&quot;</span>
<span class="sd">            5. Calculate rad_10% and rad_20% by Euclidan distance transform</span>
<span class="sd">            6. Return all in structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Step 1</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ArtifactLevel</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[Artifact] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_means</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># Step 2</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ksize</span><span class="p">,</span><span class="n">ksize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ksize</span><span class="o">*</span><span class="n">ksize</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">)</span>

        <span class="c"># Step 3</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">wid</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">contourimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">wid</span><span class="p">,</span><span class="n">hei</span><span class="p">))</span>
        <span class="n">image10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">wid</span><span class="p">,</span><span class="n">hei</span><span class="p">))</span> <span class="c"># for rad10 calculation; grey2</span>
        <span class="n">image20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">wid</span><span class="p">,</span><span class="n">hei</span><span class="p">))</span> <span class="c"># for rad20 calculation: grey1+grey2+grey3</span>

        <span class="n">gUndef</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gBlack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gGrey1</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">gGrey2</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">gGrey3</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">gGrey4</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">gGrey5</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">gWhite</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">B</span>
        <span class="n">S</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="o">-</span><span class="n">B</span><span class="p">)</span> <span class="c"># 10% for Head coil</span>
<span class="c">#        rad_10%: !grey2</span>
<span class="c">#        rad_20%: !(grey1+grey2+grey3)</span>

        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gWhite</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span> <span class="c"># Use the whole field of view for Head Coil</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                    <span class="n">pval</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pval</span><span class="o">&lt;=</span><span class="n">T</span><span class="p">):</span> <span class="c"># undef</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">gUndef</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pval</span><span class="o">&lt;=</span><span class="n">C</span><span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">S</span><span class="p">):</span> <span class="c"># black</span>
                        <span class="n">contourimage</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">gBlack</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">gBlack</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pval</span><span class="o">&lt;=</span><span class="n">C</span><span class="o">-</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">):</span> <span class="c"># grey1</span>
                        <span class="n">contourimage</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">gGrey1</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">gGrey1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">image20</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pval</span><span class="o">&lt;=</span><span class="n">C</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">):</span> <span class="c"># grey2</span>
                        <span class="n">contourimage</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">gGrey2</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">gGrey2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">image10</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">image20</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pval</span><span class="o">&lt;=</span><span class="n">C</span><span class="o">+</span><span class="n">N</span><span class="o">*</span><span class="n">S</span><span class="p">):</span> <span class="c"># grey3</span>
                        <span class="n">contourimage</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">gGrey3</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">gGrey3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">image20</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">contourimage</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">gWhite</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">gWhite</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># calculated rad10 and rad20 by euclidan distance transform</span>
            <span class="n">image10</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">image10</span><span class="p">)</span>
            <span class="n">rad10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image10</span><span class="p">)</span>
            <span class="n">xmid10</span><span class="p">,</span><span class="n">ymid10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">image10</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span><span class="n">image10</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">image20</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">image20</span><span class="p">)</span>
            <span class="n">rad20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image20</span><span class="p">)</span>
            <span class="n">xmid20</span><span class="p">,</span><span class="n">ymid20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">image20</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span><span class="n">image20</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">Ntot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="o">-</span><span class="n">counts</span><span class="p">[</span><span class="n">gUndef</span><span class="p">]</span>

            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_Ntot</span> <span class="o">=</span> <span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_mid10</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmid10</span><span class="p">,</span><span class="n">ymid10</span><span class="p">]</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_mid20</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmid20</span><span class="p">,</span><span class="n">ymid20</span><span class="p">]</span>

            <span class="c"># Report values</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_TCm20</span>    <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">counts</span><span class="p">[</span><span class="n">gBlack</span><span class="p">]</span><span class="o">/</span><span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_Cm20Cm10</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">counts</span><span class="p">[</span><span class="n">gGrey1</span><span class="p">]</span><span class="o">/</span><span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_Cm10Cp10</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">counts</span><span class="p">[</span><span class="n">gGrey2</span><span class="p">]</span><span class="o">/</span><span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_Cp10Cp20</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">counts</span><span class="p">[</span><span class="n">gGrey3</span><span class="p">]</span><span class="o">/</span><span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_Cp20MAX</span>  <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">counts</span><span class="p">[</span><span class="n">gWhite</span><span class="p">]</span><span class="o">/</span><span class="n">Ntot</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_rad10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">rad10</span><span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_rad20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">rad20</span><span class="p">)</span>

        <span class="c">#</span>
        <span class="sd">&quot;&quot;&quot; NEMA FFU</span>
<span class="sd">         int_unif = (max pixelval-min pixelval)/(max pixelval+min pixelval)*100</span>
<span class="sd">         ROI =</span>
<span class="sd">         The image is filtered to reduce noise influences on the values of the maximum pixel</span>
<span class="sd">            value and the minimum pixel value. The specification area is a circular ROI, with the</span>
<span class="sd">            centre of the image as centre and with a radius of 150mm and 300mm for the head</span>
<span class="sd">            and body coil, respectively.</span>

<span class="sd">        AS: Klopt niet. Diameter is 150mm, anders al out of phantom</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="c"># 3. Smoothing: moving average of image</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ksize</span><span class="p">,</span><span class="n">ksize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ksize</span><span class="o">*</span><span class="n">ksize</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">)</span>

        <span class="c"># 3.3 select data inside circle only</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">wid</span><span class="p">,</span> <span class="n">wid</span><span class="p">))</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">wid</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="mf">150.</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="n">rad</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_mid_linunif</span> <span class="o">=</span> <span class="p">[</span><span class="n">mid</span><span class="p">,</span><span class="n">mid</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_rad_linunif</span> <span class="o">=</span> <span class="n">rad</span>

        <span class="c"># report value</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">ffu_lin_unif</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">maxval</span><span class="o">-</span><span class="n">minval</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">maxval</span><span class="o">+</span><span class="n">minval</span><span class="p">)</span>

        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">contourimage</span><span class="p">)</span>

<span class="c">#        plt.figure()</span>
<span class="c">#        plt.imshow(contourimage.transpose())</span>
<span class="c">#        cs_mr.hasmadeplots = True</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>

</div>
<div class="viewcode-block" id="PiQT_QC.SpatialLinearity"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.SpatialLinearity">[docs]</a>    <span class="k">def</span> <span class="nf">SpatialLinearity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs_mr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The spatial linearity section of the head phantom is a regular array of 45</span>
<span class="sd">        discs. The diameter and spacing between the discs are:</span>
<span class="sd">            diameter 5 mm, distance between discs 25 mm.</span>

<span class="sd">        The program evaluates an image of the spatial linearity section as follows:</span>
<span class="sd">        1) The &#39;theoretical&#39; array of discs is matched to the array in the image.</span>
<span class="sd">        2) For every disc the shift of the centre of the disc in the image with respect to the</span>
<span class="sd">        theoretical position is determined in both the horizontal and vertical direction:</span>
<span class="sd">        A positive horizontal shift means a shift to the right and a positive vertical shift</span>
<span class="sd">        means a shift to the top of the image.</span>
<span class="sd">        The accuracy of the program is 1/4 pixel.</span>
<span class="sd">        3) For every pair of adjacent discs the program determines the so-called differential</span>
<span class="sd">        linearity:</span>
<span class="sd">            differential linearity = 100 * ( (actual dist. / theoretical dist.) - 1)</span>
<span class="sd">        This means that if the actual distance matches the theoretical one, the differential linearity will</span>
<span class="sd">        be 0%.</span>
<span class="sd">        To specify the spatial linearity, Philips defined parameters which are calculated from</span>
<span class="sd">        the shifts and differential linearity numbers:</span>
<span class="sd">            integral linearity avg: average value of shifts</span>
<span class="sd">            integral linearity std: standard deviation</span>
<span class="sd">            max_R: maximum shift to the right/upwards</span>
<span class="sd">            min_L: maximum shift to the left/downwards</span>
<span class="sd">            diff. linearity avg: average of differential linearity values</span>
<span class="sd">            diff. linearity std: standard deviation</span>
<span class="sd">            max: maximum value</span>
<span class="sd">            min: minimum value</span>

<span class="sd">        Both the integral and differential linearity, maximum and minimum values are calculated</span>
<span class="sd">        in both the horizontal and vertical direction of the image.</span>
<span class="sd">        Apart from the above parameters the size of the phantom in both horizontal and vertical</span>
<span class="sd">        direction is determined:</span>
<span class="sd">            size_hor: distance between the outer discs on the horizontal axis.</span>
<span class="sd">            size_ver: distance between the outer discs on the vertical axis.</span>

<span class="sd">        AS: The SPT manual ignores a possible scaling in the matching of theoretical grid, so</span>
<span class="sd">            I assume that the theoretical distances should remain 25 mm, and scaling should be prevented</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow:</span>
<span class="sd">            1. Make grid of theoretical positions</span>
<span class="sd">            2. Find real location starting from theoretical ones, acc 1/4 pixel</span>
<span class="sd">            3. Find Affine transformation, between theoretical positions and real locations</span>
<span class="sd">            4. Apply transform to theoretical positions</span>
<span class="sd">            5. Calculate all parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">cs_mr</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SpatialLinearity] Error: Not a valid PiQT struct&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># image sequence</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageSliceNumber</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">piqttest</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;[SpatialLinearity] ERROR: Test&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="o">.</span><span class="n">stTestSpatialLinearity</span><span class="p">,</span><span class="s">&quot;not available for given image&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># coiltype</span>
        <span class="n">coiltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoilType</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span> <span class="ow">or</span> <span class="n">coiltype</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stCoilSurface</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[SpatialLinearity] ERROR: coiltype not recognized&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># 1. grid of theoretical positions</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">snr_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ymid</span> <span class="o">=</span> <span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ncent</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">defdistmm</span> <span class="o">=</span> <span class="mf">25.</span>
        <span class="n">defdiamm</span>  <span class="o">=</span> <span class="mf">5.</span>

        <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdistmm</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">-</span> <span class="p">(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">ymid</span> <span class="o">-</span> <span class="p">(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dxy</span>
        <span class="c"># build 2d array of px coordinates, but remove corners</span>
        <span class="n">pos_gt</span> <span class="o">=</span><span class="p">[[</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">dxy</span><span class="o">+</span><span class="n">x0</span><span class="p">,</span><span class="n">y</span><span class="o">*</span><span class="n">dxy</span><span class="o">+</span><span class="n">y0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ncent</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ncent</span><span class="p">)]</span>
        <span class="n">pos_gt</span><span class="p">[</span> <span class="mi">0</span><span class="p">][</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos_gt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos_gt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos_gt</span><span class="p">[</span> <span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># 2. real location starting from theoretical ones, acc 1/4 pixel</span>
        <span class="n">pos_found</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pos_gt</span><span class="p">)</span>
        <span class="n">error</span><span class="p">,</span><span class="n">pos_found</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">FindCenters2D</span><span class="p">(</span><span class="n">pos_found</span><span class="p">,</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdistmm</span><span class="o">/</span><span class="mf">4.</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdiamm</span><span class="p">),</span><span class="n">minimod</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># 3. Find Affine transformation, between theoretical positions and real locations</span>
        <span class="c">## turn grid into list fpr matching</span>
        <span class="n">fit_posgt</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fit_posfound</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">found</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">fit_posgt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
                <span class="n">fit_posfound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>

        <span class="c">## affine transformation to find phantom shift and phantom rotation</span>
        <span class="n">trn</span> <span class="o">=</span> <span class="n">mymath</span><span class="o">.</span><span class="n">Affine_Fit</span><span class="p">(</span><span class="n">fit_posgt</span><span class="p">,</span> <span class="n">fit_posfound</span><span class="p">)</span>
        <span class="c"># print &quot;affine scaling = &quot;,trn.getScaling()</span>

        <span class="c"># 4. Apply transform to theoretical positions</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
<span class="c">#                pos_gt[y][x] = trn.Transform(gt) # for full transformation</span>
                <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">trn</span><span class="o">.</span><span class="n">RigidTransform</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span> <span class="c"># to ignore the scaling</span>

        <span class="c"># 5. do calculations</span>
        <span class="c"># find shifts between groundtruth and found</span>
        <span class="n">shiftx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shifty</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">found</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">shiftx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">shifty</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># find distances between adjacent discs</span>
        <span class="n">difflinx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">## theoretical distance should be 25 mm, but we find a scaling with affine transform</span>
        <span class="c">## or ignore it through the rigid transform</span>
        <span class="n">thpos1</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thpos0</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">thdistmm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pos0</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">difflinx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">thdistmm</span> <span class="o">-</span><span class="mf">1.</span><span class="p">))</span>

        <span class="n">diffliny</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">thpos1</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thpos0</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thdistmm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">pos0</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">diffliny</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">thdistmm</span> <span class="o">-</span><span class="mf">1.</span><span class="p">))</span>


        <span class="c"># 6. NEMA</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The NEMA spatial linearity is defined by the maximum percentage of differential linearity</span>
<span class="sd">        between the following disk pairs:</span>
<span class="sd">            2-44</span>
<span class="sd">            3-43</span>
<span class="sd">            4-42</span>
<span class="sd">            7-39</span>
<span class="sd">            11-35</span>
<span class="sd">            13-33</span>
<span class="sd">            19-27</span>
<span class="sd">            20-26</span>
<span class="sd">            NEMA integral linearity = max differential linearity (N_1...N_8)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictdiscindex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dictdiscindex</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">idx</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]})</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">nemapairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span> <span class="mi">2</span><span class="p">,</span><span class="mi">44</span><span class="p">],</span>
            <span class="p">[</span> <span class="mi">3</span><span class="p">,</span><span class="mi">43</span><span class="p">],</span>
            <span class="p">[</span> <span class="mi">4</span><span class="p">,</span><span class="mi">42</span><span class="p">],</span>
            <span class="p">[</span> <span class="mi">7</span><span class="p">,</span><span class="mi">39</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">35</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="mi">33</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">19</span><span class="p">,</span><span class="mi">27</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">26</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nemapairs</span><span class="p">:</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">id0</span> <span class="o">=</span> <span class="n">dictdiscindex</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">id1</span> <span class="o">=</span> <span class="n">dictdiscindex</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">thpos0</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">id0</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">id0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">thpos1</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">id1</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">id1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">thdistmm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">thpos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thpos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">pos0</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">id0</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">id0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">id1</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">id1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">thdistmm</span> <span class="o">-</span><span class="mf">1.</span><span class="p">))</span>

        <span class="c">## for gui</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_diampx</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdiamm</span><span class="p">)</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_posgt</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_posfound</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncent</span><span class="p">):</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">pos_gt</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">found</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_posgt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
                <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_posfound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>

        <span class="c"># Report values</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_phantomshift</span>  <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>  <span class="n">trn</span><span class="o">.</span><span class="n">getShift</span><span class="p">()]</span>
        <span class="c">## make sure we report a value between -45 and +45 degrees, and note that Philips rotates in the other direction</span>
        <span class="n">rotdeg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.</span><span class="o">*</span><span class="p">(</span><span class="n">trn</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rotdeg</span><span class="o">&gt;</span><span class="mf">45.</span><span class="p">:</span>
            <span class="n">rotdeg</span> <span class="o">-=</span> <span class="mi">90</span>
        <span class="k">while</span> <span class="n">rotdeg</span><span class="o">&lt;-</span><span class="mf">45.</span><span class="p">:</span>
            <span class="n">rotdeg</span> <span class="o">+=</span> <span class="mi">90</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_phantomrotdeg</span> <span class="o">=</span> <span class="n">rotdeg</span>
        <span class="c">## distance between horizontal and vertical outer discs</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_found</span><span class="p">[(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos_found</span><span class="p">[(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_sizehor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos_found</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">ncent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_sizever</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c">## avg and stdev and min/max of shifts</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intshiftavg</span>  <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shiftx</span><span class="p">)),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shifty</span><span class="p">))]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intshiftsdev</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shiftx</span><span class="p">)),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shifty</span><span class="p">))]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_shiftmax</span>     <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">shiftx</span><span class="p">)),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">shifty</span><span class="p">))]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_shiftmin</span>     <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">shiftx</span><span class="p">)),</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantommm</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">shifty</span><span class="p">))]</span>
        <span class="c">## avg and stdev and min/max of differential linearity horz and vert</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intdiffavg</span> <span class="o">=</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">difflinx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffliny</span><span class="p">)]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intdiffsdev</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">difflinx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diffliny</span><span class="p">)]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intdiffmax</span> <span class="o">=</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">difflinx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diffliny</span><span class="p">)]</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_intdiffmin</span> <span class="o">=</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">difflinx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">diffliny</span><span class="p">)]</span>
        <span class="c">## nema</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_nema</span><span class="p">)])</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        m/p_angle	89.98	S89 - 91</span>
<span class="sd">        preparation angle is probably Flip Angle (0018,1314), but measurement angle?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## only for displaying</span>
        <span class="c"># smoothing to get rid of noise and give max respons over avg disc</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cs_mr</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">cs_mr</span><span class="o">.</span><span class="n">lin_slice</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs_mr</span><span class="p">,</span><span class="n">defdiamm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">cs_mr</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>

<span class="c">#        print &quot;NEMA&quot;</span>
<span class="c">#        for la,ne in zip(cs_mr.lin_nema_label, cs_mr.lin_nema):</span>
<span class="c">#            print la,ne</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>


</div>
<div class="viewcode-block" id="PiQT_QC.DICOMInfo"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.DICOMInfo">[docs]</a>    <span class="k">def</span> <span class="nf">DICOMInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;dicom&#39;</span><span class="p">,</span><span class="n">imslice</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Different from ImageJ version; tags &quot;0008&quot;,&quot;0104&quot; and &quot;0054&quot;,&quot;0220&quot;</span>
        <span class="c">#  appear to be part of sequences. This gives problems (cannot be found</span>
        <span class="c">#  or returning whole sequence blocks)</span>
        <span class="c"># Possibly this can be solved by using if(type(value) == type(dicom.sequence.Sequence()))</span>
        <span class="c">#  but I don&#39;t see the relevance of these tags anymore, so set them to NO</span>
        <span class="k">if</span> <span class="n">info</span> <span class="o">==</span> <span class="s">&quot;dicom&quot;</span><span class="p">:</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
		    <span class="p">[</span><span class="s">&quot;0010,0010&quot;</span><span class="p">,</span> <span class="s">&quot;Patients Name&quot;</span><span class="p">],</span> <span class="c"># PIQT</span>
		    <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span> <span class="s">&quot;Protocol Name&quot;</span><span class="p">],</span>  <span class="c"># QA1S:MS,SE</span>
		    <span class="p">[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span> <span class="s">&quot;Series Date&quot;</span><span class="p">],</span>
		    <span class="p">[</span><span class="s">&quot;0008,0031&quot;</span><span class="p">,</span> <span class="s">&quot;Series Time&quot;</span><span class="p">],</span><span class="c"># no ScanTime 0008,0032 in EnhancedDicom</span>
		    <span class="p">[</span><span class="s">&quot;0018,1250&quot;</span><span class="p">,</span> <span class="s">&quot;Receive Coil Name&quot;</span><span class="p">],</span> <span class="c"># Q-Body</span>
		    <span class="p">[</span><span class="s">&quot;0018,1251&quot;</span><span class="p">,</span> <span class="s">&quot;Transmit Coil Name&quot;</span><span class="p">],</span> <span class="c"># B</span>
		    <span class="p">[</span><span class="s">&quot;0018,0095&quot;</span><span class="p">,</span> <span class="s">&quot;Pixel Bandwidth&quot;</span><span class="p">],</span> <span class="c"># 219</span>
		    <span class="p">[</span><span class="s">&quot;0018,0020&quot;</span><span class="p">,</span> <span class="s">&quot;Scanning Sequence&quot;</span><span class="p">],</span> <span class="c"># SE</span>
		    <span class="p">[</span><span class="s">&quot;0018,0021&quot;</span><span class="p">,</span> <span class="s">&quot;Scanning Variant&quot;</span><span class="p">],</span> <span class="c"># SS</span>
		    <span class="p">[</span><span class="s">&quot;2005,1011&quot;</span><span class="p">,</span> <span class="s">&quot;Image_Type&quot;</span><span class="p">],</span> <span class="c"># M</span>
		    <span class="p">[</span><span class="s">&quot;0018,0081&quot;</span><span class="p">,</span> <span class="s">&quot;Echo Time&quot;</span><span class="p">],</span> <span class="c"># 50</span>
		    <span class="p">[</span><span class="s">&quot;0020,0012&quot;</span><span class="p">,</span> <span class="s">&quot;Acquisition Number&quot;</span><span class="p">],</span> <span class="c"># 5</span>
		    <span class="p">[</span><span class="s">&quot;0018,0086&quot;</span><span class="p">,</span> <span class="s">&quot;Echo Number(s)&quot;</span><span class="p">],</span> <span class="c"># 1</span>
		    <span class="p">[</span><span class="s">&quot;2001,1081&quot;</span><span class="p">,</span> <span class="s">&quot;Dyn_Scan_No&quot;</span><span class="p">],</span> <span class="c"># ?1</span>
		    <span class="p">[</span><span class="s">&quot;0020,0013&quot;</span><span class="p">,</span> <span class="s">&quot;Instance Number&quot;</span><span class="p">],</span> <span class="c"># 1 slice no?</span>
		    <span class="p">[</span><span class="s">&quot;2001,105f,2005,1079&quot;</span><span class="p">,</span> <span class="s">&quot;Dist_sel&quot;</span><span class="p">],</span> <span class="c"># -16.32</span>
		    <span class="p">[</span><span class="s">&quot;2001,1083&quot;</span><span class="p">,</span> <span class="s">&quot;Central_freq&quot;</span><span class="p">],</span> <span class="c"># 63.895241 (MHz)</span>
		    <span class="p">[</span><span class="s">&quot;0018,1020&quot;</span><span class="p">,</span> <span class="s">&quot;SoftwareVersions&quot;</span><span class="p">],</span> <span class="c"># 63.895241 (MHz)</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">info</span> <span class="o">==</span> <span class="s">&quot;id&quot;</span><span class="p">:</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span> <span class="s">&quot;Protocol Name&quot;</span><span class="p">],</span>  <span class="c"># QA1S:MS,SE</span>
                <span class="p">[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span> <span class="s">&quot;Series Date&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,0031&quot;</span><span class="p">,</span> <span class="s">&quot;Series Time&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dicomfields</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">imslice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s">&quot;0018,1020&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="PiQT_QC.DetermineScanID"><a class="viewcode-back" href="../../../../Plugins.MRI.MRI_PIQT.html#Plugins.MRI.MRI_PIQT.QCMR_lib.PiQT_QC.DetermineScanID">[docs]</a>    <span class="k">def</span> <span class="nf">DetermineScanID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="c"># 2. determine QA1/QA2/QA3</span>
        <span class="n">dicomkey</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span> <span class="s">&quot;ProtocolName&quot;</span><span class="p">]</span>  <span class="c"># QA1S:MS,SE</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">dicomkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;QA1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">scanID</span> <span class="o">=</span> <span class="s">&#39;QA1&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;QA2&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">scanID</span> <span class="o">=</span> <span class="s">&#39;QA2&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;QA3&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">scanID</span> <span class="o">=</span> <span class="s">&#39;QA3&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">scanID</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>

        <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">scanID</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>