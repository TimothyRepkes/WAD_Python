<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Plugin_development.Fluoro.Pehamed.QCDDL_lib &mdash; ..  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="..  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for Plugin_development.Fluoro.Pehamed.QCDDL_lib</h1><div class="highlight"><pre>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;aschilha&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Warning: THIS MODULE EXPECTS PYQTGRAPH DATA: X AND Y ARE TRANSPOSED! And make sure rescaling is corrected!</span>

<span class="sd">TODO:</span>
<span class="sd">Changelog:</span>
<span class="sd">    20150616: better orientation module</span>
<span class="sd">    20150609: Initial from QCXRay_Lib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">dicom</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="kn">as</span> <span class="nn">scind</span>
<span class="kn">import</span> <span class="nn">QCDDL_constants</span> <span class="kn">as</span> <span class="nn">lit</span>
<span class="kn">from</span> <span class="nn">pyWADLib</span> <span class="kn">import</span> <span class="n">wadwrapper_lib</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">fft</span> <span class="k">as</span> <span class="n">fftpack</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span> <span class="c"># image from pillow is needed</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageDraw</span> <span class="c"># imagedraw from pillow is needed, not pil</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="c"># sanity check: we need at least scipy 0.10.1 to avoid problems mixing PIL and Pillow</span>
<span class="n">scipy_version</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span> <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)]</span>
<span class="k">if</span> <span class="n">scipy_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span> <span class="ow">or</span> <span class="p">(</span><span class="n">scipy_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">scipy_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;scipy version too old. Upgrade scipy to at least 0.10.1&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DDLStruct"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct">[docs]</a><span class="k">class</span> <span class="nc">DDLStruct</span><span class="p">:</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">knownHorizontalOrVertical</span> <span class="o">=</span> <span class="bp">None</span>
    
<div class="viewcode-block" id="DDLStruct.Room"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.Room">[docs]</a>    <span class="k">class</span> <span class="nc">Room</span> <span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>       <span class="c"># identifier of room</span>
        <span class="n">outvalue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c"># value of pixels outside x-ray field</span>
        <span class="n">sidHorizontal_mm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
        <span class="n">sidVertical_mm</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
        <span class="n">p2mm512Horizontal</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c"># factor to convert pix in 512 to mm on phantom; from manual fit</span>
        <span class="n">p2mm512Vertical</span>   <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">protocolHorizontal</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">protocolVertical</span>   <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">phantom</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stPehamed</span>
        <span class="n">skipFFT</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># only for wellhofer</span>
        <span class="n">sdthresh</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># threshold on stdev for determin table or wall, now only for CALHOS, maybe WKZ?</span>

        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_name</span><span class="p">,</span> <span class="n">outvalue</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">sHmm</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sVmm</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">pH2mm</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pV2mm</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">protocolH</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">protocolV</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">phantom</span><span class="o">=</span><span class="n">lit</span><span class="o">.</span><span class="n">stPehamed</span><span class="p">,</span><span class="n">sdthresh</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outvalue</span> <span class="o">=</span> <span class="n">outvalue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sidHorizontal_mm</span>  <span class="o">=</span> <span class="n">sHmm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sidVertical_mm</span>    <span class="o">=</span> <span class="n">sVmm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2mm512Horizontal</span> <span class="o">=</span> <span class="n">pH2mm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2mm512Vertical</span>   <span class="o">=</span> <span class="n">pV2mm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocolHorizontal</span> <span class="o">=</span> <span class="n">protocolH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocolVertical</span> <span class="o">=</span> <span class="n">protocolV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phantom</span> <span class="o">=</span> <span class="n">phantom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdthresh</span> <span class="o">=</span> <span class="n">sdthresh</span>
            <span class="k">if</span><span class="p">(</span><span class="n">phantom</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWellhofer</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipFFT</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># room names</span>
    <span class="c">#    roomWKZ1 = Room(&quot;WKZ1&quot;,outvalue=1023,tablesid=1150,wallsid=2000, tablepid=60, wallpid=45,phantom=&quot;wellhofer&quot;)</span>
    <span class="c"># wkz tablepid=30 from fit</span></div>
    <span class="n">roomF7</span> <span class="o">=</span> <span class="n">Room</span><span class="p">(</span><span class="s">&quot;AZUDDL&quot;</span><span class="p">,</span> <span class="n">outvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sHmm</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span><span class="n">sVmm</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span><span class="n">pH2mm</span><span class="o">=</span><span class="mf">0.6384</span><span class="p">,</span><span class="n">pV2mm</span><span class="o">=</span><span class="mf">0.6384</span><span class="p">,</span><span class="n">protocolH</span><span class="o">=</span><span class="s">&#39;HSG&#39;</span><span class="p">,</span><span class="n">protocolV</span><span class="o">=</span><span class="s">&#39;Defaec&#39;</span><span class="p">)</span>
    <span class="c">#roomF7.skipFFT = True</span>
    <span class="n">roomUnknown</span> <span class="o">=</span> <span class="n">Room</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span><span class="p">)</span>
    <span class="n">guessroom</span> <span class="o">=</span> <span class="n">roomUnknown</span>

<div class="viewcode-block" id="DDLStruct.UnifStruct"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.UnifStruct">[docs]</a>    <span class="k">class</span> <span class="nc">UnifStruct</span> <span class="p">:</span>
        <span class="n">ROIuniformity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># fraction</span>
        <span class="n">LRuniformity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># fraction</span>
        <span class="n">LineUniformity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># fraction</span>
        <span class="n">BKmean</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># gridless bk</span>
        <span class="n">BKsdev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># gridless bk stdev</span>
        <span class="n">peakValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># max valule over uniformity line</span>
        <span class="n">posval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trendMin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">trendMax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">verticalROI</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROIuniformity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRuniformity</span> <span class="o">=</span> <span class="n">LineUniformity</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BKmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BKsdev</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peakValue</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posval</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trendMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trendMin</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verticalROI</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="DDLStruct.CuStruct"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.CuStruct">[docs]</a>    <span class="k">class</span> <span class="nc">CuStruct</span> <span class="p">:</span>
        <span class="n">roi_snr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">roi_cnr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">roi_mmcu</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">roi_mean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">roi_sdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dynamicRange</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">guesskVp</span>     <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">slope</span>        <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wedge_confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_snr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_cnr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_mmcu</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_mean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_sdev</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dynamicRange</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guesskVp</span>     <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slope</span>        <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_rois</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wedge_confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
            </div>
<div class="viewcode-block" id="DDLStruct.LoCoStruct"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.LoCoStruct">[docs]</a>    <span class="k">class</span> <span class="nc">LoCoStruct</span> <span class="p">:</span>
        <span class="n">low_cnr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mean_sg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mean_bk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdev_sg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdev_bk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lo_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_cnr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_sg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_bk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdev_sg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdev_bk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lo_rois</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#####################</span>
    <span class="c"># input image</span></div>
    <span class="n">dcmInfile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pixeldataIn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">dicomMode</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span>

    <span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># if pixval(Cu) = high and pixval(air) = low, then mustbeinverted</span>
    <span class="n">expertOverridepixToGridScaleCm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">bbox_confidence</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c"># phantom orientation</span>
    <span class="n">po_center_roi</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># xmid,ymid,rad</span>
    <span class="n">po_roi</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># list [ [x,y] ]</span>
    <span class="n">po_fftroi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">po_rot</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># only is phantom is rotate multiple of 90</span>
    <span class="n">test_rois</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">po_angledeg</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># exact angle of rotation after multiple of 90</span>

    <span class="c"># horz. uniformity</span>
    <span class="n">unif</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Cu Wedge</span>
    <span class="n">cuwedge</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Low Contrast</span>
    <span class="n">loco</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">lastimage</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># GUI feedback</span>

    <span class="c"># for matlib plotting</span>
    <span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="DDLStruct.readDICOMtag"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.readDICOMtag">[docs]</a>    <span class="k">def</span> <span class="nf">readDICOMtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span> <span class="c"># slice=2 is image 3</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dcmInfileRaw</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imslice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="DDLStruct.maybeInvert"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.maybeInvert">[docs]</a>    <span class="k">def</span> <span class="nf">maybeInvert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PhotometricInterpretation</span> <span class="o">==</span> <span class="s">&quot;MONOCHROME2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">True</span>
            
        <span class="c"># somehow does not give the correct behaviour for DDL</span>
        <span class="c"># hence a more pragmatic approach: </span>
        <span class="c"># if the mode of the hostogram of pixelvalues of a large part of the image &gt; middle bin, then do invert</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>
        <span class="n">heightpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sqsize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">widthpx</span><span class="p">,</span><span class="n">heightpx</span><span class="p">)</span>
        <span class="n">midx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">widthpx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">midy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">heightpx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sqpart</span> <span class="o">=</span> <span class="mi">5</span> <span class="c"># was 3 for CR/DR</span>
        <span class="n">smallimage</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span> <span class="p">[</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">,</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">],[</span><span class="n">midx</span><span class="p">,</span><span class="n">midy</span><span class="p">])</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">peakpos</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">peakpos</span><span class="o">&lt;</span><span class="n">peakpos</span><span class="o">-</span><span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">print</span> <span class="s">&quot;Must be Inverted&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span>
</div>
<div class="viewcode-block" id="DDLStruct.determineDeviceID"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLStruct.determineDeviceID">[docs]</a>    <span class="k">def</span> <span class="nf">determineDeviceID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roomUnknown</span>

        <span class="n">stationnames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">&quot;AZUDDL&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">roomF7</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s">&quot;0008,1010&quot;</span><span class="p">,</span>  <span class="s">&quot;Station Name&quot;</span><span class="p">],[</span><span class="s">&quot;0018,1000&quot;</span><span class="p">,</span><span class="s">&quot;Device Serial Number&quot;</span><span class="p">]]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">dicomfields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dicvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dicvalue</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">dicvalue</span> <span class="o">=</span> <span class="n">dicvalue</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">stationnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dicvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span> <span class="o">=</span> <span class="n">sn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">print</span> <span class="s">&quot;DetermineDeviceID:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="n">dicvalue</span><span class="p">,</span><span class="s">&#39;)&#39;</span>
                    <span class="k">return</span>
        <span class="c"># try one of the DDLrooms;</span>
        <span class="n">didiserialnumber</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">&quot;24211830&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">roomF7</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">dicomfields</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dicvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dicvalue</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">didiserialnumber</span><span class="p">:</span>
                <span class="k">if</span>  <span class="n">dicvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span> <span class="o">=</span> <span class="n">sn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">print</span> <span class="s">&quot;DetermineDeviceID:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="n">dicvalue</span><span class="p">,</span><span class="s">&#39;)&#39;</span>
                    <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dcmInfile</span><span class="p">,</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="n">dicomMode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfileRaw</span> <span class="o">=</span> <span class="n">dcmInfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataInRaw</span> <span class="o">=</span> <span class="n">pixeldataIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="o">=</span> <span class="n">dcmInfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">pixeldataIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">=</span> <span class="n">dicomMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imslice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># one name for 2D 3D</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicomMode</span> <span class="o">!=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">stMode2D</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imslice</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixeldataInRaw</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfileRaw</span><span class="o">.</span><span class="n">info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataInRaw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imslice</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expertOverridepixToGridScaleCm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mustbeinverted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guessroom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roomUnknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po_center_roi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po_roi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po_rot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po_angledeg</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po_fftroi</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UnifStruct</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuwedge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CuStruct</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoCoStruct</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_confidence</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">determineDeviceID</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixeldataIn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeInvert</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DDLQC"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC">[docs]</a><span class="k">class</span> <span class="nc">DDLQC</span><span class="p">:</span>
    <span class="n">qcversion</span> <span class="o">=</span> <span class="mi">20150616</span>

    <span class="n">boxradmm</span>   <span class="o">=</span> <span class="mi">110</span>  <span class="c"># choose 11 cm or 8 cm for clean surroundings</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span> <span class="o">=</span> <span class="mi">110</span>
        
<div class="viewcode-block" id="DDLQC.readDICOMtag"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.readDICOMtag">[docs]</a>    <span class="k">def</span> <span class="nf">readDICOMtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">key</span><span class="p">):</span> <span class="c"># slice=2 is image 3</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfileRaw</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">imslice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="DDLQC.pixToGridScaleCm"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.pixToGridScaleCm">[docs]</a>    <span class="k">def</span> <span class="nf">pixToGridScaleCm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cs</span><span class="o">.</span><span class="n">expertOverridepixToGridScaleCm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">expertOverridepixToGridScaleCm</span>

        <span class="n">pixel_spacing_x</span> <span class="o">=</span> <span class="mf">512.</span><span class="o">/</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">Rows</span>
        <span class="n">stand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HorizontalOrVertical</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="c"># calculate distance = L0-Thick</span>
        <span class="k">if</span> <span class="n">stand</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stHorizontal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pixel_spacing_x</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">p2mm512Horizontal</span>

        <span class="k">return</span> <span class="n">pixel_spacing_x</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">p2mm512Vertical</span>
</div>
<div class="viewcode-block" id="DDLQC.pix2phantomm"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.pix2phantomm">[docs]</a>    <span class="k">def</span> <span class="nf">pix2phantomm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixToGridScaleCm</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pix</span><span class="o">*</span><span class="n">pix2phantommm</span>
</div>
<div class="viewcode-block" id="DDLQC.phantommm2pix"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.phantommm2pix">[docs]</a>    <span class="k">def</span> <span class="nf">phantommm2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span><span class="n">mm</span><span class="p">):</span>
        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixToGridScaleCm</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mm</span><span class="o">/</span><span class="n">pix2phantommm</span>
</div>
<div class="viewcode-block" id="DDLQC.diamondNESW"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.diamondNESW">[docs]</a>    <span class="k">def</span> <span class="nf">diamondNESW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">roipts_orig</span><span class="p">):</span>
        <span class="c"># turn into diamond</span>
        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#North</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">0</span><span class="p">])),(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="c">#East</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">0</span><span class="p">])),(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="c">#South</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">0</span><span class="p">])),(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="c">#West</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">0</span><span class="p">])),(</span><span class="nb">int</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">roipts_orig</span><span class="p">[</span><span class="n">ix2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="k">return</span> <span class="n">roipts</span>
</div>
<div class="viewcode-block" id="DDLQC.phantomposmm2pix"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.phantomposmm2pix">[docs]</a>    <span class="k">def</span> <span class="nf">phantomposmm2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roipts_orig</span><span class="p">,</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">ymm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert position as indicated on phantom to image pixels</span>

<span class="sd">        input: x and y coordinates in phantom grid mm</span>
<span class="sd">        output: x and y in pix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dirNESW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diamondNESW</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>

        <span class="n">xmid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ymid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts_orig</span><span class="p">:</span>
            <span class="n">xmid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ymid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">ymid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>

        <span class="n">xpx</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">+</span> <span class="n">ymm</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">*</span><span class="p">(</span><span class="n">dirNESW</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span> <span class="o">+</span><span class="n">xmm</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">*</span><span class="p">(</span><span class="n">dirNESW</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span>
        <span class="n">ypx</span> <span class="o">=</span> <span class="n">ymid</span> <span class="o">+</span><span class="n">ymm</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">*</span><span class="p">(</span><span class="n">dirNESW</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span><span class="o">+</span><span class="n">xmm</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">*</span><span class="p">(</span><span class="n">dirNESW</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xpx</span><span class="p">,</span><span class="n">ypx</span>

<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.invertmaxval"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.invertmaxval">[docs]</a>    <span class="k">def</span> <span class="nf">invertmaxval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="c"># Not stored properly in self.dcmfileIn.BitsStored</span>
        <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s">&quot;0028,0101&quot;</span><span class="p">,</span>  <span class="s">&quot;Bits Stored&quot;</span><span class="p">]]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">dicomfields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dicvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dicvalue</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dicvalue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="DDLQC.HorizontalOrVertical"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.HorizontalOrVertical">[docs]</a>    <span class="k">def</span> <span class="nf">HorizontalOrVertical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">knownHorizontalOrVertical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">knownHorizontalOrVertical</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">ProtocolName</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">protocolHorizontal</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">lit</span><span class="o">.</span><span class="n">stHorizontal</span>
        <span class="k">elif</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">ProtocolName</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">protocolVertical</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">lit</span><span class="o">.</span><span class="n">stVertical</span>

        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">knownHorizontalOrVertical</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">protocolHorizontal</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">protocolVertical</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">ProtocolName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.findPhantomOrientation"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.findPhantomOrientation">[docs]</a>    <span class="k">def</span> <span class="nf">findPhantomOrientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ebbox</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="c"># 1.1 find approx center of phantom (screw)</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>
        <span class="n">heightpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sqsize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">widthpx</span><span class="p">,</span><span class="n">heightpx</span><span class="p">)</span>
        <span class="n">midx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">widthpx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">midy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">heightpx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sqpart</span> <span class="o">=</span> <span class="mi">5</span> <span class="c"># was 3 for CR/DR</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span> <span class="o">-</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span> <span class="p">[</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">,</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">],[</span><span class="n">midx</span><span class="p">,</span><span class="n">midy</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span> <span class="p">[</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">,</span><span class="n">sqsize</span><span class="o">/</span><span class="n">sqpart</span><span class="p">],[</span><span class="n">midx</span><span class="p">,</span><span class="n">midy</span><span class="p">])</span>
        <span class="n">smallimage</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">smallimage</span>

        <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">smallimage</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">immidx</span> <span class="o">=</span> <span class="n">midx</span><span class="o">-</span><span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">x0</span>
        <span class="n">immidy</span> <span class="o">=</span> <span class="n">midy</span><span class="o">-</span><span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">y0</span>
        <span class="n">rad</span><span class="o">=</span><span class="mi">20</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">po_center_roi</span> <span class="o">=</span> <span class="p">[</span><span class="n">immidx</span><span class="p">,</span><span class="n">immidy</span><span class="p">,</span><span class="n">rad</span><span class="p">]</span> <span class="c"># feedback for GUI</span>

        <span class="c"># 1.2 position 10x10phantomcm box and manipulate corner positions</span>
        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixToGridScaleCm</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="c"># choose 11cm each direction or 8 cm</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">/</span><span class="n">pix2phantommm</span>
        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)]</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">ebbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="n">ebbox</span>
            <span class="n">radpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="p">)</span>
            <span class="n">mindist</span> <span class="o">=</span> <span class="n">radpts</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">110</span><span class="p">]:</span>
                <span class="n">radtest</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">pix2phantommm</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">radtest</span><span class="o">-</span><span class="n">radpts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">mindist</span><span class="p">:</span>
                    <span class="n">mindist</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">print</span> <span class="s">&quot;found mindist=&quot;</span><span class="p">,</span><span class="n">mindist</span><span class="p">,</span><span class="s">&quot;rad=&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span>
        <span class="c"># try to find rotation of phantom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">skipFFT</span><span class="p">:</span>
            <span class="n">error</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">rotangledeg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FieldRotationFFT</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span> <span class="c"># probably too small angle, so try again</span>
                <span class="n">error</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">rotangledeg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FieldRotationFFT</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="mf">30.</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">rotangledeg</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">po_angledeg</span> <span class="o">=</span> <span class="n">rotangledeg</span>
        
        <span class="n">cs</span><span class="o">.</span><span class="n">bbox_confidence</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">last_attempt</span><span class="o">=</span> <span class="bp">False</span>
            <span class="n">radmmtests</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">60</span><span class="p">]</span><span class="c">#[80,110,90,70,60]</span>
            <span class="k">for</span> <span class="n">radmm</span> <span class="ow">in</span> <span class="n">radmmtests</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;radmm=</span><span class="si">%d</span><span class="s">, &#39;</span><span class="o">%</span><span class="n">radmm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span> <span class="o">=</span> <span class="n">radmm</span>
                <span class="n">rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">/</span><span class="n">pix2phantommm</span>
                <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)]</span> <span class="p">]</span>
                <span class="n">roipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RotateBoundingBox</span><span class="p">(</span><span class="n">roipts</span><span class="p">,</span><span class="n">rotangledeg</span><span class="p">)</span>
                <span class="n">error</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">bbox_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="s">&quot;BoundingBox&quot;</span><span class="p">,</span><span class="n">last_attempt</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">xa</span><span class="p">,</span><span class="n">ya</span><span class="p">)</span> <span class="ow">in</span> <span class="n">roipts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">xa</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">ya</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">elif</span> <span class="n">xa</span><span class="o">&gt;=</span><span class="n">widthpx</span> <span class="ow">or</span> <span class="n">ya</span><span class="o">&gt;=</span><span class="n">heightpx</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rotangledeg</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">2.</span><span class="p">:</span>
                    <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)],</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">immidx</span><span class="o">+</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">immidy</span><span class="o">-</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+.</span><span class="mi">5</span><span class="p">)]</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="n">radmm</span><span class="o">&lt;</span><span class="mi">61</span><span class="p">:</span>
                        <span class="n">last_attempt</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">error</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">bbox_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="s">&quot;BoundingBox&quot;</span><span class="p">,</span><span class="n">last_attempt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">print</span> <span class="s">&quot;using rad,conf:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">bbox_confidence</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span> <span class="o">=</span> <span class="n">roipts</span>
        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="DDLQC.RotateBoundingBox"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.RotateBoundingBox">[docs]</a>    <span class="k">def</span> <span class="nf">RotateBoundingBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roipts_orig</span><span class="p">,</span><span class="n">rotangledeg</span><span class="p">):</span>
        <span class="n">xmid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ymid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts_orig</span><span class="p">:</span>
            <span class="n">xmid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ymid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">ymid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">xmid</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ymid</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymid</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">anglerad</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotangledeg</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">costerm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">anglerad</span><span class="p">)</span>
        <span class="n">sinterm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">anglerad</span><span class="p">)</span>
        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts_orig</span><span class="p">:</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">+</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span><span class="o">*</span><span class="n">costerm</span><span class="o">-</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span><span class="o">*</span><span class="n">sinterm</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">ymid</span> <span class="o">+</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span><span class="o">*</span><span class="n">sinterm</span><span class="o">+</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span><span class="o">*</span><span class="n">costerm</span>
            <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xp</span><span class="p">,</span><span class="n">yp</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">roipts</span>
</div>
    <span class="k">def</span> <span class="nf">_fieldRotationFFT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">smallimage</span><span class="p">,</span><span class="n">initangle</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">runmode</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c"># Start FFT</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">smallimage</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">))</span>
        <span class="c"># Now shift the quadrants around so that low spatial frequencies are in</span>
        <span class="c"># the center of the 2D fourier transformed image.</span>
        <span class="n">F2</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span> <span class="n">F1</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">runmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># Calculate a 2D power spectrum</span>
            <span class="n">psd2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">F2</span> <span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
            <span class="n">fwid</span> <span class="o">=</span> <span class="n">psd2D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fhei</span> <span class="o">=</span> <span class="n">psd2D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">psd2D</span>
    
            <span class="n">kwart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">fwid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">fhei</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fwid</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fhei</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">kwart</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psd2D</span><span class="p">[</span><span class="n">fwid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">x</span><span class="p">,</span><span class="n">fhei</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">kwart</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psd2D</span><span class="p">[</span><span class="n">fhei</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">fwid</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">x</span><span class="p">]</span>
    
            <span class="n">kwartmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kwart</span><span class="p">)</span>
            <span class="c"># Find local maxima</span>
            <span class="n">posxmax</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">posymax</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kwart2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">fwid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">fhei</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">20</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kwart</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">:</span>
                <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">kwart</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">kwart</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span><span class="n">xx</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">yy</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">posxmax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                    <span class="n">posymax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
                    <span class="n">kwart2</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwart</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span>
                <span class="n">kwart</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
            <span class="c"># a bit of sorting:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">))</span>
            <span class="n">index</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">posxmax</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">)</span>
            <span class="n">posxmax</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">posxmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">posymax</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">posymax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
    
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">posxmax</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="n">posxmax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">10.</span><span class="p">:</span> <span class="c"># skip low 10 pct</span>
                    <span class="n">posxmax</span> <span class="o">=</span> <span class="n">posxmax</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                    <span class="n">posymax</span> <span class="o">=</span> <span class="n">posymax</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                    <span class="k">break</span>
            <span class="n">maxoff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="c">#</span>
            <span class="n">r2angleoff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">r2intslope</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">maxoff</span><span class="p">):</span>
                <span class="c"># Following kludge is needed to prevent division by zero in linregress for small angle</span>
                <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ssxm</span><span class="p">,</span> <span class="n">ssxym</span><span class="p">,</span> <span class="n">ssyxm</span><span class="p">,</span> <span class="n">ssym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">posxmax</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)],</span><span class="n">posymax</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)],</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span>
                <span class="k">if</span> <span class="n">ssxm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">nonidentical</span><span class="p">:</span>
                    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r1_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">posxmax</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)],</span><span class="n">posymax</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)])</span>
                    <span class="n">anglerad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">slope</span><span class="p">)</span> <span class="c"># needs inverse angle</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">r1_value</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">r2angleoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="n">off</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">r2intslope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="n">off</span><span class="p">)</span> <span class="p">)</span>
                <span class="c">#print r2,anglerad,off</span>
                <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ssxm</span><span class="p">,</span> <span class="n">ssxym</span><span class="p">,</span> <span class="n">ssyxm</span><span class="p">,</span> <span class="n">ssym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">posxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">-</span><span class="n">off</span><span class="p">],</span><span class="n">posymax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">-</span><span class="n">off</span><span class="p">],</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span>
                <span class="k">if</span> <span class="n">ssxm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">nonidentical</span><span class="p">:</span>
                    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r1_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">posxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">-</span><span class="n">off</span><span class="p">],</span><span class="n">posymax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">posxmax</span><span class="p">)</span><span class="o">-</span><span class="n">off</span><span class="p">])</span>
                    <span class="n">anglerad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">slope</span><span class="p">)</span> <span class="c"># needs inverse angle</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">r1_value</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">r2angleoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="o">-</span><span class="n">off</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">r2intslope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="o">-</span><span class="n">off</span><span class="p">)</span> <span class="p">)</span>
                <span class="c">#print r2,anglerad,-off</span>
    
            <span class="n">r2angleoff</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r2angleoff</span><span class="p">)</span>
            <span class="n">r2</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="n">off</span> <span class="o">=</span> <span class="n">r2angleoff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">dummy1</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">slope</span> <span class="p">,</span><span class="n">dummy2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r2intslope</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">posxmax</span><span class="p">,</span><span class="n">posymax</span><span class="p">,</span><span class="s">&#39;bo&#39;</span><span class="p">)</span>
                <span class="n">dafit</span> <span class="o">=</span> <span class="p">[</span><span class="n">intercept</span><span class="o">+</span><span class="n">slope</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">posxmax</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">posxmax</span><span class="p">,</span><span class="n">dafit</span><span class="p">,</span><span class="s">&#39;b-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Orientation&quot;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;orientation fit: </span><span class="si">%f</span><span class="s"> + </span><span class="si">%f</span><span class="s">*x; offset=</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="n">dummy2</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;angledeg=</span><span class="si">%f</span><span class="s">,initangledeg=</span><span class="si">%f</span><span class="s">;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">anglerad</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="p">,</span><span class="mi">0</span> <span class="k">if</span> <span class="n">initangle</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">initangle</span><span class="p">)</span>
                <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># &#39;new&#39;</span>
            <span class="c"># must yield anglerad and r2</span>
            <span class="c">#Let&#39;s log-scale the image so we&#39;re dealing with something in uint8 range.</span>
            <span class="c"># Calculate a 2D power spectrum</span>
            <span class="n">abs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">F2</span> <span class="p">)</span><span class="c">#**2.</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">abs_data</span>

            <span class="c"># Threshold the lower 25% of the peak</span>
            <span class="n">max_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">abs_data</span><span class="p">)</span>
            <span class="n">abs_data</span><span class="p">[</span><span class="n">abs_data</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">max_peak</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c"># Log-scale the data</span>
            <span class="n">abs_data</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">255.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">max_peak</span><span class="p">)</span>
            <span class="n">log_data</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">abs_data</span><span class="p">)</span>
            
            <span class="c"># fit data through points within 90% of the max peak of the scaled image</span>
            <span class="c"># run for both angles (horz grid and vert grid)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">log_data</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">wid</span><span class="p">,</span><span class="n">hei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">wid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">hei</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">wid</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">wid</span><span class="p">,</span><span class="n">hei</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">hei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
            
            <span class="c"># we will sort on number of points, as it is easier to fit to less points, but more points should be prefered</span>
            <span class="n">r2anglenum</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">log_data1</span> <span class="o">=</span> <span class="n">log_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">log_data1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">max_scaled_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_data1</span><span class="p">)</span>

                <span class="c"># Determine the angle of two high-peak points in the image</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">log_data1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_scaled_peak</span> <span class="o">*</span> <span class="mf">0.90</span><span class="p">))</span>
                <span class="c"># Following kludge is needed to prevent division by zero in linregress for small angle</span>
                <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ssxm</span><span class="p">,</span> <span class="n">ssxym</span><span class="p">,</span> <span class="n">ssyxm</span><span class="p">,</span> <span class="n">ssym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span>
                <span class="k">if</span> <span class="n">ssxm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nonidentical</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">nonidentical</span><span class="p">:</span>
                    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r1_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">)</span>
                    <span class="n">anglerad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">slope</span><span class="p">)</span> <span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="c"># needs inverse angle</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anglerad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.</span>
                    <span class="n">r1_value</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">intercept</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">print</span> <span class="s">&#39;run </span><span class="si">%d</span><span class="s"> angle: </span><span class="si">%f</span><span class="s"> (</span><span class="si">%f</span><span class="s">), r2=</span><span class="si">%f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="n">anglerad</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="p">,</span><span class="n">r1_value</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">r2anglenum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">r1_value</span><span class="o">**</span><span class="mf">2.</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
                <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="s">&#39;bo&#39;</span><span class="p">)</span>
                    <span class="n">dafit</span> <span class="o">=</span> <span class="p">[</span><span class="n">intercept</span><span class="o">+</span><span class="n">slope</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">dafit</span><span class="p">,</span><span class="s">&#39;b-&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Orientation&quot;</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&#39;orientation fit: </span><span class="si">%f</span><span class="s"> + </span><span class="si">%f</span><span class="s">*x&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span><span class="n">slope</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&#39;angledeg=</span><span class="si">%f</span><span class="s">,initangledeg=</span><span class="si">%f</span><span class="s">;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">anglerad</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="p">,</span><span class="mi">0</span> <span class="k">if</span> <span class="n">initangle</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">initangle</span><span class="p">)</span>
                    <span class="c">#plt.show()</span>
                    <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="n">avg_angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">wavg_angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span><span class="n">r2anglenum</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;avgangle: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">avg_angle</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="o">+</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">initangle</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">initangle</span><span class="p">))</span>
            <span class="n">r2anglenum</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="c"># 0 = maxr2, 2 = maxnum</span>
            <span class="c">#r2anglenum = sorted(r2anglenum)</span>
            <span class="n">r2</span><span class="p">,</span><span class="n">anglerad</span><span class="p">,</span><span class="n">num</span> <span class="o">=</span> <span class="n">r2anglenum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c">#r2,anglerad = avg_r2,avg_angle</span>
            <span class="c">#r2,anglerad = avg_r2,wavg_angle</span>
        <span class="k">return</span> <span class="n">anglerad</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">off</span> <span class="c"># must return angle in rad, confidence measure and offset if any</span>
        
<div class="viewcode-block" id="DDLQC.FieldRotationFFT"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.FieldRotationFFT">[docs]</a>    <span class="k">def</span> <span class="nf">FieldRotationFFT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">initangle</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cut out a part of the phantom that should contain only grid</span>
<span class="sd">        Make a FFT, select one quadrant and find the locations of the first N maximums</span>
<span class="sd">        Fit a line through the maximums</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">xmid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ymid</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts_orig</span><span class="p">:</span>
            <span class="n">xmid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ymid</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">ymid</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">xmid</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmid</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ymid</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymid</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">boxradpx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">20.</span><span class="p">))</span>
        <span class="n">yoffpx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">10.</span><span class="p">))</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmid</span><span class="o">-</span><span class="n">boxradpx</span><span class="p">,</span><span class="n">ymid</span><span class="o">-</span><span class="n">yoffpx</span><span class="p">]</span>
        <span class="n">ur</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmid</span><span class="o">+</span><span class="n">boxradpx</span><span class="p">,</span><span class="n">ymid</span><span class="o">-</span><span class="n">yoffpx</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">boxradpx</span><span class="p">]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">po_fftroi</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ll</span><span class="p">,</span> <span class="p">[</span><span class="n">ur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ur</span><span class="p">,</span> <span class="p">[</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ur</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">]</span> <span class="c"># x0,wid y0,height</span>

        <span class="n">xlo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ylo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ur</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yhi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ur</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">initangle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span> <span class="c"># allow for extra artificial rotation of phantom</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="n">initangle</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reshape</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span> <span class="o">-</span> <span class="n">smallimage</span>
        <span class="k">if</span> <span class="mi">1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">os.path</span>
            <span class="n">dumppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">),</span><span class="s">&#39;temp&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dumppath</span><span class="p">,</span><span class="s">&#39;smallimage.npy&#39;</span><span class="p">),</span> <span class="n">smallimage</span><span class="p">)</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">lastimage</span> <span class="o">=</span> <span class="n">smallimage</span>
        <span class="c">#return True, roipts_orig,-360</span>
        
        <span class="n">anglerad</span><span class="p">,</span><span class="n">confidence</span><span class="p">,</span><span class="n">off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldRotationFFT</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">smallimage</span><span class="p">,</span><span class="n">initangle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initangle</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">anglerad</span> <span class="o">+=</span> <span class="n">initangle</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">anglerad</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">:</span>
            <span class="n">anglerad</span> <span class="o">=</span> <span class="n">anglerad</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">rotangledeg</span> <span class="o">=</span> <span class="p">(</span><span class="n">anglerad</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">180.</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">confidence</span><span class="o">&lt;</span><span class="mf">0.85</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;first try&quot;</span>
            <span class="k">if</span> <span class="n">initangle</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Error!&quot;</span>
            <span class="k">print</span> <span class="s">&quot;FieldRotationFFT:&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s">&quot;confidence too low:&quot;</span><span class="p">,</span><span class="n">confidence</span><span class="p">,</span><span class="n">off</span>
            <span class="c">#print offanglerad</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">rotangledeg</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">print</span> <span class="s">&quot;rotangledegFFT:&quot;</span><span class="p">,</span><span class="n">rotangledeg</span><span class="p">,</span><span class="n">confidence</span><span class="p">,</span><span class="n">off</span>

        <span class="n">roipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RotateBoundingBox</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">rotangledeg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">rotangledeg</span>
</div>
<div class="viewcode-block" id="DDLQC.AlignROI"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.AlignROI">[docs]</a>    <span class="k">def</span> <span class="nf">AlignROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">roipts</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span><span class="n">blast_attempt</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixToGridScaleCm</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="c"># choose 11cm each direction or 8 cm</span>
        <span class="n">searchrad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2.5</span><span class="o">/</span><span class="n">pix2phantommm</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span> <span class="c"># 2 mm around location</span>

        <span class="n">workimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span>
        <span class="n">searchrad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">searchrad</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> searchrad=&quot;</span><span class="o">%</span><span class="n">what</span><span class="p">,</span><span class="n">searchrad</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">workimage</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>
        <span class="n">heightpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">workimage</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">conf_pts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c">#        conf_pts.append((self.ROIConfidence(cs,roipts,what),copy.deepcopy(roipts)))</span>
        <span class="n">conf_pts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">roipts</span><span class="p">)))</span> <span class="c"># never not select default pointset</span>
        <span class="n">roipts0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts</span><span class="p">)):</span>
                <span class="n">rp</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x0</span><span class="o">-</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">widthpx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">x0</span><span class="o">+</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y0</span><span class="o">-</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">heightpx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                    <span class="n">cropped</span> <span class="o">=</span> <span class="n">workimage</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cropped</span> <span class="o">=</span> <span class="n">invertmax</span> <span class="o">-</span> <span class="n">workimage</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="c">#plt.figure()</span>
                <span class="c">#plt.imshow(cropped)</span>
                <span class="c">#plt.show()</span>
                <span class="c"># smoothing to get rid of noise</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="n">cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>
                <span class="n">cropped</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
                <span class="c"># find maximum location in projections</span>
                <span class="n">xflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">yflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">minx</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">yflat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">yflat</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">miny</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">xflat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">xflat</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
                <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConsistencyAlign</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts0</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">what</span><span class="p">)</span>
            <span class="n">conf_pts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ROIConfidence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">what</span><span class="p">),</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">roipts</span><span class="p">)))</span>

        <span class="c"># Just take the last one; should be best!</span>
<span class="c">#        conf_pts = sorted(conf_pts) #sorting orientation/distance box does worsen results</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">roipts</span><span class="p">)):</span>
            <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">conf_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">confidence</span><span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">blast_attempt</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Error!&quot;</span>
            <span class="k">print</span> <span class="s">&quot;AlignRoi (&quot;</span><span class="p">,</span><span class="n">what</span><span class="p">,</span><span class="s">&quot;):&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s">&quot;, confidence too low:&quot;</span><span class="p">,</span><span class="n">confidence</span>

        <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">confidence</span>
</div>
<div class="viewcode-block" id="DDLQC.ConsistencyAlign"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.ConsistencyAlign">[docs]</a>    <span class="k">def</span> <span class="nf">ConsistencyAlign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span><span class="n">roiptsold</span><span class="p">,</span> <span class="n">roiptsnew</span><span class="p">,</span><span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        4 types of motion:</span>
<span class="sd">            1. Shift (all points move in same direction)</span>
<span class="sd">            2. Scale (all distance to center change by same amount)</span>
<span class="sd">            3. Rotation (all points rotate along same angle around center)</span>
<span class="sd">            4. Shear (some points rotate more than others. Do not allow)</span>
<span class="sd">        Some heuristics to correct for one corner point being very obviously wrong</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">midx0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">midy0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roiptsold</span><span class="p">:</span>
            <span class="n">midx0</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">midy0</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">midx0</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roiptsold</span><span class="p">)</span>
        <span class="n">midy0</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roiptsold</span><span class="p">)</span>

<span class="c">#        shifts = []</span>
        <span class="n">shiftdist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c">#        scales = []</span>
<span class="c">#        angles = []</span>
        <span class="k">for</span> <span class="n">rp0</span><span class="p">,</span><span class="n">rp1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roiptsold</span><span class="p">,</span> <span class="n">roiptsnew</span><span class="p">):</span>
<span class="c">#            shifts.append([rp1[0]-rp0[0],rp1[1]-rp0[1]])</span>
            <span class="n">shiftdist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">rp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rp0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">rp1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rp0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="c">#            dist1 = np.sqrt((rp1[0]-midx0)**2+(rp1[1]-midy0)**2)</span>
<span class="c">#            scales.append(dist1/d0)</span>
<span class="c">#            angles.append(np.arctan2(rp1[1]-rp0[1],rp1[0]-rp0[0]))</span>

        <span class="k">if</span><span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="s">&quot;BoundingBox&quot;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            [int(immidx-rad/2+.5),int(immidy-rad/2+.5)],</span>
<span class="sd">             [int(immidx-rad/2+.5),int(immidy+rad/2+.5)],</span>
<span class="sd">              [int(immidx+rad/2+.5),int(immidy+rad/2+.5)],</span>
<span class="sd">               [int(immidx+rad/2+.5),int(immidy-rad/2+.5)] ]</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">idcmp</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">abc</span> <span class="ow">in</span> <span class="n">idcmp</span><span class="p">:</span>
                <span class="n">i0</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">l1</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">5.</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">shiftdist</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">shiftdist</span><span class="p">[</span><span class="n">i1</span><span class="p">]):</span>
                        <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiptsnew</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roiptsnew</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="c">#sanity check</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>
        <span class="n">heightpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">roiptsnew</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x0</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">y0</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">roiptsold</span>
            <span class="k">if</span> <span class="n">x0</span><span class="o">&gt;=</span><span class="n">widthpx</span> <span class="ow">or</span> <span class="n">y0</span><span class="o">&gt;=</span><span class="n">heightpx</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">roiptsold</span>
        <span class="k">return</span> <span class="n">roiptsnew</span>
</div>
<div class="viewcode-block" id="DDLQC.ROIConfidence"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.ROIConfidence">[docs]</a>    <span class="k">def</span> <span class="nf">ROIConfidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">what</span><span class="p">):</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c"># First the lengths of just the sides of the box</span>
        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixToGridScaleCm</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="n">redlength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxradmm</span><span class="o">/</span><span class="n">pix2phantommm</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>
        <span class="c"># now add diagonals</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>

        <span class="k">if</span><span class="p">(</span><span class="n">what</span><span class="o">==</span><span class="s">&quot;BoundingBox&quot;</span><span class="p">):</span>
            <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate lengths and</span>
<span class="sd">		    // need to check only is NS^2 == len0^2+len1^2 and EW^2=len2^2+len3^2</span>
<span class="sd">		    // 1cm dev must lead to fail. So lengths (12cm) minus 11cm. Scaling is from (sid+10)/sid.</span>
<span class="sd">		    // find magnification</span>
<span class="sd">		    // we want a cm dev to drop confidence to 0.5, so all lengths (emperically) need to be reduced by magnified 11cm</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">roipts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x0</span><span class="p">][</span><span class="n">y0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x0</span><span class="p">][</span><span class="n">y0</span><span class="p">]</span> <span class="o">==</span><span class="n">invertmax</span><span class="p">:</span> <span class="c"># on annotation</span>
                    <span class="k">return</span> <span class="mi">0</span>

            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="c"># ns via nes east+north</span>
            <span class="n">length1</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">length2</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">length2</span><span class="o">&gt;</span><span class="n">length1</span><span class="p">):</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length1</span><span class="o">/</span><span class="n">length2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">*=</span><span class="n">length2</span><span class="o">/</span><span class="n">length1</span>

                <span class="c"># ns via west+south</span>
            <span class="n">length1</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">lengths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">length2</span><span class="o">&gt;</span><span class="n">length1</span><span class="p">):</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length1</span><span class="o">/</span><span class="n">length2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length2</span><span class="o">/</span><span class="n">length1</span>

            <span class="c"># ew via north+west</span>
            <span class="n">length1</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">length2</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">length2</span><span class="o">&gt;</span><span class="n">length1</span><span class="p">):</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length1</span><span class="o">/</span><span class="n">length2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length2</span><span class="o">/</span><span class="n">length1</span>

            <span class="c"># ew via east+south</span>
            <span class="n">length1</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">length2</span><span class="o">&gt;</span><span class="n">length1</span><span class="p">):</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length1</span><span class="o">/</span><span class="n">length2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="n">length2</span><span class="o">/</span><span class="n">length1</span>

            <span class="c"># punish for not being equal to input boxsize</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">confidence</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">redlength</span><span class="p">,</span><span class="n">lengths</span><span class="p">[</span><span class="n">p</span><span class="p">])</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">redlength</span><span class="p">,</span><span class="n">lengths</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">confidence</span> <span class="o">**</span><span class="mf">2.</span> <span class="c"># 6 is too strict for deformations in DDL; power 3 is max!</span>

        <span class="k">print</span> <span class="n">what</span><span class="o">+</span><span class="s">&quot;Confidence = &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mf">100.</span><span class="p">),</span><span class="s">&quot;%&quot;</span>
        <span class="k">return</span> <span class="n">confidence</span>

<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.HorizontalUniformity"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.HorizontalUniformity">[docs]</a>    <span class="k">def</span> <span class="nf">HorizontalUniformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">roipts_orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span>

        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="c"># Make box 1 cm from edges of x-ray E and W, from 7cm to 9cm mark on N</span>

        <span class="c"># box runs from (xmm,ymm) = (edgeW+10,70) to (edgeE-10,90)</span>
        <span class="n">xmidpx</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ymidpx</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts_orig</span><span class="p">:</span>
            <span class="n">xmidpx</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ymidpx</span> <span class="o">+=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmidpx</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">ymidpx</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">)</span>
        <span class="n">xmidpx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmidpx</span><span class="p">)</span>
        <span class="n">ymidpx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymidpx</span><span class="p">)</span>
        <span class="n">yhipx</span> <span class="o">=</span> <span class="n">ymidpx</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">90.</span><span class="p">))</span>
        <span class="n">ylopx</span> <span class="o">=</span> <span class="n">ymidpx</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">70.</span><span class="p">))</span>
        <span class="n">seppx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">10.</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>

        <span class="n">outvalue</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">outvalue</span>
        <span class="c"># for DiDi, just take the minimal corner value</span>
        <span class="k">if</span> <span class="n">outvalue</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">outvalue</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
            <span class="n">outvalue</span> <span class="o">=</span> <span class="n">invertmax</span><span class="o">-</span><span class="n">outvalue</span>

        <span class="c"># Try lefthand side first</span>
        <span class="n">hiyarr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loyarr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmidpx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                <span class="n">hiyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">yhipx</span><span class="p">])</span>
                <span class="n">loyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">ylopx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hiyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">yhipx</span><span class="p">])</span>
                <span class="n">loyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">ylopx</span><span class="p">])</span>
        
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hiyarr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmidpx</span><span class="p">),</span><span class="n">hiyarr</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&gt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&lt;</span><span class="n">outvalue</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&lt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">outvalue</span><span class="p">):</span>
                <span class="n">x1px</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>
        
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loyarr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmidpx</span><span class="p">),</span><span class="n">loyarr</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&gt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&lt;</span><span class="n">outvalue</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&lt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">outvalue</span><span class="p">):</span>
                <span class="n">x2px</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>
        <span class="n">xlopx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1px</span><span class="p">,</span><span class="n">x2px</span><span class="p">)</span><span class="o">+</span><span class="n">seppx</span>

        <span class="c"># Now righthand side</span>
        <span class="n">hiyarr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loyarr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmidpx</span><span class="p">,</span><span class="n">widthpx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                <span class="n">hiyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">yhipx</span><span class="p">])</span>
                <span class="n">loyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">ylopx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hiyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">yhipx</span><span class="p">])</span>
                <span class="n">loyarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">ylopx</span><span class="p">])</span>

        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hiyarr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmidpx</span><span class="p">)),</span><span class="nb">reversed</span><span class="p">(</span><span class="n">hiyarr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&gt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&lt;</span><span class="n">outvalue</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&lt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">outvalue</span><span class="p">):</span>
                <span class="n">x1px</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>
        
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loyarr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmidpx</span><span class="p">)),</span><span class="nb">reversed</span><span class="p">(</span><span class="n">loyarr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&gt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&lt;</span><span class="n">outvalue</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">outvalue</span><span class="o">&lt;</span><span class="n">meanval</span> <span class="ow">and</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">outvalue</span><span class="p">):</span>
                <span class="n">x2px</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>
        <span class="n">xhipx</span> <span class="o">=</span> <span class="n">xmidpx</span><span class="o">+</span><span class="nb">min</span><span class="p">(</span><span class="n">x1px</span><span class="p">,</span><span class="n">x2px</span><span class="p">)</span><span class="o">-</span><span class="n">seppx</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	    step 2 run Uniformity check and report only roiuniformity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlopx</span><span class="p">,</span><span class="n">yhipx</span><span class="p">],[</span><span class="n">xhipx</span><span class="p">,</span><span class="n">yhipx</span><span class="p">],[</span><span class="n">xhipx</span><span class="p">,</span><span class="n">ylopx</span><span class="p">],[</span><span class="n">xlopx</span><span class="p">,</span><span class="n">ylopx</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Uniformity</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="DDLQC.Uniformity"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.Uniformity">[docs]</a>    <span class="k">def</span> <span class="nf">Uniformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">what</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">bshowplot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Concept:</span>
<span class="sd">        1. Cut out rectangular roi</span>
<span class="sd">        2. mask out the copper grid</span>
<span class="sd">        3. calculate line profile</span>
<span class="sd">        4. Check for difference between left and right</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">roipts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">roi</span>

        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="c"># 1. cut out roi</span>
        <span class="n">xmin</span><span class="o">=</span><span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmax</span><span class="o">=</span><span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ymin</span><span class="o">=</span><span class="n">roipts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">roipts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">roipts</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># 2. mask out copper grid (afterwards copper = 1)</span>
        <span class="n">enhance</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">mask_offset</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">nbsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&quot;lowcontrast&quot;</span><span class="p">:</span>
            <span class="n">option</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># option0: use all, do not look for grid</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">ma</span><span class="o">.</span><span class="n">make_mask_none</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">smallimage</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c"># option1: ImageJ autothreshold</span>
                <span class="n">histo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">smallimage</span><span class="p">))))</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">threshold_isodata2</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">smallimage</span><span class="o">&gt;</span><span class="n">level</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># option2: what I used in QCXRay, but no erosion</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">threshold_adaptive</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span> <span class="n">nbsize</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">mask_offset</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">threshold_adaptive</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span> <span class="n">nbsize</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">mask_offset</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">enhance</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Uniformity image&#39;</span><span class="o">+</span><span class="n">what</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Uniformity Mask&#39;</span><span class="o">+</span><span class="n">what</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">hasemadeplots</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># 3. calculate line profile</span>
        <span class="n">posval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mincount</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">hei</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span> <span class="c"># masked = true = do NOT include</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">smallimage</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">mx2</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">((</span><span class="n">smallimage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">BKcount</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">BKmean</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="n">BKcount</span>
        <span class="n">BKsumsq</span> <span class="o">=</span> <span class="n">mx2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="n">BKcount</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sums</span>   <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">wid</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">&gt;</span><span class="n">mincount</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">sums</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">/</span><span class="n">counts</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="n">intens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">posval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">ix</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posval</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">counts</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: Uniformity </span><span class="si">%s</span><span class="s">: no valid pixels found.&quot;</span><span class="o">%</span><span class="n">what</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Uniformity image&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Uniformity Mask&#39;</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">BKcount</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">BKmean</span> <span class="o">/=</span> <span class="n">BKcount</span>
            <span class="n">BKsdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BKsumsq</span><span class="o">/</span><span class="n">BKcount</span><span class="o">-</span><span class="n">BKmean</span><span class="o">*</span><span class="n">BKmean</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&quot;lowcontrast&quot;</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKmean</span> <span class="o">=</span> <span class="n">BKmean</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKsdev</span> <span class="o">=</span> <span class="n">BKsdev</span>
            <span class="k">return</span>

        <span class="n">cufraction</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">wid</span><span class="o">*</span><span class="n">hei</span><span class="o">-</span><span class="n">BKcount</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">wid</span><span class="o">*</span><span class="n">hei</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cufraction</span><span class="o">&lt;.</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cufraction</span><span class="o">&gt;.</span><span class="mi">9</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: Uniformity: invalid Cu fraction &quot;</span><span class="p">,</span><span class="n">cufraction</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="k">print</span> <span class="n">cufraction</span>
        <span class="k">if</span>  <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">bshowplot</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">posval</span><span class="p">,</span><span class="n">intens</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Uniformity&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;positon on phantom [mm]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;average intensity&#39;</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c">## line uniformity</span>
        <span class="n">intemin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">intens</span><span class="p">)</span>
        <span class="n">intemax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intens</span><span class="p">)</span>
        <span class="n">inteavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">intens</span><span class="p">)</span>
        <span class="n">overlengthuniformity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">intemax</span><span class="o">-</span><span class="n">inteavg</span><span class="p">,</span><span class="n">inteavg</span><span class="o">-</span><span class="n">intemin</span><span class="p">])</span><span class="o">/</span><span class="n">inteavg</span>

        <span class="c">## left/right uniformity</span>
        <span class="n">inteavgL</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cutpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">hei</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">posval</span><span class="p">,</span><span class="n">intens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">&lt;</span><span class="n">cutpos</span><span class="p">:</span>
                <span class="n">inteavgL</span> <span class="o">+=</span> <span class="n">val</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">inteavgL</span> <span class="o">/=</span> <span class="n">count</span>

        <span class="n">inteavgR</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cutpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">wid</span><span class="o">-</span><span class="n">hei</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">posval</span><span class="p">,</span><span class="n">intens</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pos</span><span class="o">&gt;</span><span class="n">cutpos</span><span class="p">):</span>
                <span class="n">inteavgR</span> <span class="o">+=</span> <span class="n">val</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">inteavgR</span> <span class="o">/=</span> <span class="n">count</span>
        <span class="n">LRuniformity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">inteavgR</span><span class="o">+</span><span class="n">inteavgL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">LRuniformity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inteavgR</span><span class="o">-</span><span class="n">inteavgL</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">inteavgR</span><span class="o">+</span><span class="n">inteavgL</span><span class="p">)</span>
        <span class="c">## ROI uniformity</span>
        <span class="n">inteavgROI</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cutpos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,(</span><span class="n">wid</span><span class="o">-</span><span class="n">hei</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">cutpos2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2phantomm</span><span class="p">(</span><span class="n">cs</span><span class="p">,(</span><span class="n">wid</span><span class="o">+</span><span class="n">hei</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">posval</span><span class="p">,</span><span class="n">intens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">&gt;</span><span class="n">cutpos1</span> <span class="ow">and</span> <span class="n">pos</span><span class="o">&lt;</span><span class="n">cutpos2</span><span class="p">:</span>
                <span class="n">inteavgROI</span> <span class="o">+=</span> <span class="n">val</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">inteavgROI</span> <span class="o">/=</span> <span class="n">count</span>
        <span class="n">ROIuniformity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inteavgR</span><span class="o">-</span><span class="n">inteavgROI</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inteavgROI</span><span class="o">-</span><span class="n">inteavgL</span><span class="p">)])</span><span class="o">/</span><span class="n">inteavgROI</span>
        <span class="k">print</span> <span class="s">&quot;LineUniformity%=&quot;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">overlengthuniformity</span>
        <span class="k">print</span> <span class="s">&quot;LRuniformity%=&quot;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">LRuniformity</span>
        <span class="k">print</span> <span class="s">&quot;ROIuniformity%=&quot;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">ROIuniformity</span>
        <span class="k">print</span> <span class="s">&quot;AAPMROIlimit%=&quot;</span><span class="p">,</span><span class="mi">10</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">LineUniformity</span> <span class="o">=</span> <span class="n">overlengthuniformity</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">ROIuniformity</span> <span class="o">=</span> <span class="n">ROIuniformity</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">LRuniformity</span> <span class="o">=</span> <span class="n">LRuniformity</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKmean</span> <span class="o">=</span> <span class="n">BKmean</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKsdev</span> <span class="o">=</span> <span class="n">BKsdev</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">posval</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">posval</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">intens</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">intens</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		// Report</span>
<span class="sd">		/* note AAPM_39 states:</span>
<span class="sd">		   For film output (hard-copy), optical densities are measured in the center of each quadrant</span>
<span class="sd">		   of the film and in the center position to determine absolute density and spatial uniformity.</span>
<span class="sd">		   Central film density is acceptable if within 0.10 OD of the programmed OD value (usually</span>
<span class="sd">		   1.20). Spatial uniformity is acceptable when all measured OD values are within ~10% of the</span>
<span class="sd">		   average OD. For soft-copy evaluation of the images on a workstation, the average digital value</span>
<span class="sd">		   of each ROI should be within 10% of the global average. Standard deviation should also be sim-</span>
<span class="sd">		   ilar in each of the five ROIs.</span>
<span class="sd">		   SD/Av &lt; 5%</span>
<span class="sd">		*/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>
<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.CuWedge"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.CuWedge">[docs]</a>    <span class="k">def</span> <span class="nf">CuWedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span> <span class="n">roipts_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># 1. Make box around wedge</span>
        <span class="c"># 2. Find all steps and do some statistcs</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">roipts_orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span>

        <span class="c"># 1. Make box around wedge (-5.5; -4) to (+5.5; -5.5)</span>
        <span class="n">bump</span> <span class="o">=</span> <span class="mf">2.</span>
        <span class="n">xmmll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">55.</span><span class="o">+</span><span class="n">bump</span>
        <span class="n">ymmur</span> <span class="o">=</span> <span class="o">-</span><span class="mf">55.</span><span class="o">+</span><span class="n">bump</span>
        <span class="n">xmmur</span> <span class="o">=</span>  <span class="mf">55.</span><span class="o">-</span><span class="n">bump</span>
        <span class="n">ymmll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.</span><span class="o">-</span><span class="n">bump</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">phantom</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWellhofer</span><span class="p">:</span>
            <span class="n">xmmll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">55.</span><span class="o">+</span><span class="mf">4.</span>
            <span class="n">ymmur</span> <span class="o">=</span> <span class="o">-</span><span class="mf">60.</span><span class="o">+</span><span class="mf">3.</span>
            <span class="n">xmmur</span> <span class="o">=</span>  <span class="mf">55.</span><span class="o">-</span><span class="mf">4.</span>
            <span class="n">ymmll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">43.</span><span class="o">-</span><span class="mf">2.</span>

        <span class="n">xpxll</span><span class="p">,</span><span class="n">ypxll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">xmmll</span><span class="p">,</span><span class="n">ymmll</span><span class="p">)</span> <span class="c"># lowerlef</span>
        <span class="n">xpxur</span><span class="p">,</span><span class="n">ypxur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">xmmur</span><span class="p">,</span><span class="n">ymmur</span><span class="p">)</span> <span class="c"># upperright</span>
        <span class="n">xpxul</span><span class="p">,</span><span class="n">ypxul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">xmmll</span><span class="p">,</span><span class="n">ymmur</span><span class="p">)</span> <span class="c"># upperleft</span>
        <span class="n">xpxlr</span><span class="p">,</span><span class="n">ypxlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">xmmur</span><span class="p">,</span><span class="n">ymmll</span><span class="p">)</span> <span class="c"># lowerright</span>

        <span class="c"># box needs to be horizontal</span>
        <span class="n">xlo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">xpxll</span><span class="p">,</span><span class="n">xpxul</span><span class="p">))</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">xpxlr</span><span class="p">,</span><span class="n">xpxur</span><span class="p">))</span>
        <span class="n">ylo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">ypxlr</span><span class="p">,</span><span class="n">ypxll</span><span class="p">))</span>
        <span class="n">yhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">ypxur</span><span class="p">,</span><span class="n">ypxul</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ylo</span><span class="o">&gt;</span><span class="n">yhi</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[CuWedge]: Error, phantom angle too large, cannot sample wedge&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="c"># 1. Make box around wedge (-5.5; -4) to (+5.5; -5.5)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlo</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">],[</span><span class="n">xlo</span><span class="p">,</span><span class="n">ylo</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnalyseWedge</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span>
</div>
<div class="viewcode-block" id="DDLQC.AnalyseWedge"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.AnalyseWedge">[docs]</a>    <span class="k">def</span> <span class="nf">AnalyseWedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concept:</span>
<span class="sd">            1. Cut out rectangular roi</span>
<span class="sd">            2. For each cu step, measure mean and sd</span>
<span class="sd">            4. Calculate SNR and CNR</span>
<span class="sd">            5. Calculate kV</span>

<span class="sd">        NB excel data fit shows perfectly linear pehamed Cu intensity with {0.55, 0.50, 0.40, 0.30, 0.20, 0.10, 0.00} (F10 after recalib 20090720)</span>
<span class="sd">        to make the 0.00 Cu lie on the line, all thicknesses other than 0.00 should be increased by 0.125mm</span>
<span class="sd">        the wellhofer wkz table1 data perfectly agrees with {0.57, 0.50, 0.40, 0.30, 0.20, 0.10, 0.00} including zero point</span>

<span class="sd">        Assuming that we have a linear read out (as it should be for Qc) meaning pixel value ~ -mu x</span>
<span class="sd">        By fitting a linear line through the mean pixelvalues of each step, we obtain I = a x + b</span>
<span class="sd">        If we compare the found coefficient a with the reference value which was obtained for a calibrated kV, we can</span>
<span class="sd">        calculate the current kV by linear interpolation from the NIST X-RAY Data for Cu; find the kV for which the ratio a/a_ref is the</span>
<span class="sd">        same as mu/mu_ref perfect predict if use 0.6 instead of 0.55</span>

<span class="sd">        Contrast from Cu Mean/SD?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">roipts_orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi</span>

        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">iec_wellhofer</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="mf">0.4</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>  <span class="mf">0.2</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">]</span>   <span class="c"># mm Cu; wellhofer</span>
<span class="c">#        din_pehamed   = [2.3, 1.85, 1.40, 1.00, 0.65, 0.30, 0.00] # mm Cu; IBA, Digi13, pehamed?</span>
        <span class="c">#    1. Cut out rectangular roi</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ymin</span><span class="o">&gt;</span><span class="n">ymax</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[AnalyseWedge]: Error, phantom angle too large, cannot sample wedge&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">wid</span> <span class="o">=</span> <span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">smallimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cu Wedge&#39;</span><span class="p">)</span>

        <span class="c"># 2.1 make a profile</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wid</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">wid</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">hei</span><span class="p">):</span>
                <span class="n">profile</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">smallimage</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span>
            <span class="n">profile</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">/=</span><span class="n">hei</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cu Wedge derivative&#39;</span><span class="p">)</span>

        <span class="c"># 2.2 Find the edges between the steps</span>
        <span class="n">n_edges</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">posedges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># find peaks</span>
        <span class="n">pfactor</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">xy_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_max</span><span class="p">)</span><span class="o">&lt;</span><span class="n">n_edges</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">/</span><span class="n">pfactor</span><span class="o">&gt;.</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pfactor</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">xy_max</span><span class="p">,</span><span class="n">xy_min</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">peakdet</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">/</span><span class="n">pfactor</span><span class="p">)</span> <span class="c"># returns indices for freqs</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_max</span><span class="p">)</span><span class="o">&gt;</span><span class="n">n_edges</span> <span class="ow">and</span> <span class="n">pfactor</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pfactor</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">xy_max</span><span class="p">,</span><span class="n">xy_min</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">peakdet</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">/</span><span class="n">pfactor</span><span class="p">)</span> <span class="c"># returns indices for freqs</span>

        <span class="n">posedges</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">xy_max</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_edges</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[AnalyseWedge]: Error, cannot find 6 edges: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">wedge_confidence</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">wedge_confidence</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">n_edges</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">))</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">n_edges</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)))</span><span class="o">**</span><span class="mf">3.</span> <span class="c"># must be 6! </span>
        <span class="n">avg_dist</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">posedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">posedges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">posedges</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">-</span><span class="n">posedges</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">wedge_confidence</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span><span class="n">avg_dist</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">avg_dist</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Edge 0 at &quot;</span><span class="p">,</span><span class="n">posedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">posedges</span><span class="p">)):</span>
                <span class="k">print</span> <span class="s">&quot;Edge &quot;</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="s">&quot; at &quot;</span><span class="p">,</span><span class="n">posedges</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span><span class="s">&quot; sep= &quot;</span><span class="p">,</span><span class="n">posedges</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">-</span><span class="n">posedges</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># 2.3 Calculate statistics for each step</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xlo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ylo</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c"># flatpix</span>
        <span class="n">yhi</span> <span class="o">=</span> <span class="n">hei</span> <span class="c"># - flatpix</span>
        <span class="k">if</span> <span class="n">ylo</span><span class="o">&gt;</span><span class="n">yhi</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;[AnalyseWedge]: Error, phantom angle too large, cannot sample wedge&quot;</span>
            <span class="k">return</span> <span class="n">error</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">step_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flatpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mf">2.5</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">posedges</span><span class="p">:</span>
            <span class="n">xlo</span> <span class="o">+=</span> <span class="n">flatpix</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">flatpix</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">])</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">value</span> <span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">smallimage</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">])</span> <span class="p">)</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlo</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">yhi</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xhi</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">yhi</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xhi</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">ylo</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xlo</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">ylo</span><span class="o">+</span><span class="n">ymin</span><span class="p">]</span> <span class="p">]</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">step_rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">xlo</span> <span class="o">+=</span> <span class="n">flatpix</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="n">wid</span><span class="o">-</span><span class="n">flatpix</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">])</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">value</span> <span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">smallimage</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlo</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">yhi</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xhi</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">yhi</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xhi</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">ylo</span><span class="o">+</span><span class="n">ymin</span><span class="p">],[</span><span class="n">xlo</span><span class="o">+</span><span class="n">xmin</span><span class="p">,</span><span class="n">ylo</span><span class="o">+</span><span class="n">ymin</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">step_rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_snr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_edges</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_snr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">/</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="p">)</span>
            <span class="c">#roi_cnr.append( np.sqrt(2.*(roi_mean[ix]-roi_mean[n_edges])**2/(roi_sdev[ix]**2+roi_sdev[n_edges]**2) )</span>
            <span class="k">if</span> <span class="n">ix</span><span class="o">&lt;</span><span class="n">n_edges</span><span class="p">:</span>
                <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">iec_wellhofer</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">dynamicRange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="n">n_edges</span><span class="p">]</span><span class="o">/</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="n">n_edges</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;mmCu&quot;</span><span class="p">,</span><span class="s">&quot;SNR&quot;</span><span class="p">,</span><span class="s">&quot;CNR&quot;</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_snr</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">c</span>

            <span class="c">#cu_cs.guesskVp = guesskVp</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	    guesskVp = EstimatekV(roi_mean, roi_mmcu,give_info,cs);</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">error</span>
    <span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.LowContrast"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.LowContrast">[docs]</a>    <span class="k">def</span> <span class="nf">LowContrast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for each disc, calc av in box in center and in box 1 cm above it (without Cu grid)</span>
<span class="sd">        Calculate CNR: (av(Cu)-av(bk))/sqrt((sd(Cu)^2+sd(bk)^2)/2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">roipts_orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span>

        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">low_cnr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mean_sg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mean_bk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdev_sg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdev_bk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># pehamed</span>
        <span class="n">mmCu</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="o">-</span><span class="mf">25.</span><span class="p">,</span><span class="o">-</span><span class="mf">35.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">15.</span><span class="p">,</span><span class="o">-</span><span class="mf">35.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">05.</span><span class="p">,</span><span class="o">-</span><span class="mf">35.</span><span class="p">],</span> <span class="p">[</span><span class="mf">05.</span><span class="p">,</span><span class="o">-</span><span class="mf">35.</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">CuDimmm</span> <span class="o">=</span> <span class="mf">04.</span>
        <span class="n">yrefmm</span> <span class="o">=</span> <span class="mf">10.</span> <span class="c"># offset to background</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">phantom</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWellhofer</span><span class="p">:</span>
            <span class="n">mmCu</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="mf">36.4</span><span class="p">,</span><span class="mf">22.8</span><span class="p">],</span> <span class="p">[</span><span class="mf">31.</span><span class="p">,</span><span class="mf">17.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">25.</span><span class="p">,</span><span class="mf">11.9</span><span class="p">],</span> <span class="p">[</span><span class="mf">19.3</span><span class="p">,</span><span class="mf">06.</span><span class="p">]</span> <span class="p">]</span>
            <span class="n">CuDimmm</span> <span class="o">=</span> <span class="mf">02.5</span>
            <span class="n">yrefmm</span> <span class="o">=</span> <span class="mf">5.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peha</span> <span class="o">=</span> <span class="n">DDLStruct</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfileRaw</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataInRaw</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">dicomMode</span><span class="p">)</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">lo_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cu</span> <span class="ow">in</span> <span class="n">mmCu</span><span class="p">:</span>
            <span class="c"># first calculate statistics for low contrast object</span>
            <span class="n">llx</span><span class="p">,</span><span class="n">lly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">urx</span><span class="p">,</span><span class="n">ury</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">lrx</span><span class="p">,</span><span class="n">lry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">ulx</span><span class="p">,</span><span class="n">uly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">cu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">CuDimmm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llx</span><span class="p">,</span><span class="n">ulx</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">yhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lly</span><span class="p">,</span><span class="n">lry</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">urx</span><span class="p">,</span><span class="n">lrx</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">ylo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">uly</span><span class="p">,</span><span class="n">ury</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlo</span><span class="p">,</span><span class="n">ylo</span><span class="p">],[</span><span class="n">xlo</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">]</span> <span class="p">]</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">lo_rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span> <span class="o">-</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">roi_mean_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">roi_sdev_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">mean_sg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_mean_s</span><span class="p">)</span>
            <span class="n">sdev_sg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_sdev_s</span><span class="p">)</span>

            <span class="c"># next calculate statistics for background</span>
            <span class="n">ylo</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">yrefmm</span><span class="p">))</span>
            <span class="n">yhi</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">phantommm2pix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">yrefmm</span><span class="p">))</span>
            <span class="n">roipts</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">xlo</span><span class="p">,</span><span class="n">ylo</span><span class="p">],[</span><span class="n">xlo</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">]</span> <span class="p">]</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">lo_rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">phantom</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWellhofer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                    <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span> <span class="o">-</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">roi_mean_bk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
                <span class="n">roi_sdev_bk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Uniformity</span><span class="p">(</span><span class="n">peha</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="s">&quot;lowcontrast&quot;</span><span class="p">)</span>
                <span class="n">roi_mean_bk</span> <span class="o">=</span> <span class="n">peha</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKmean</span>
                <span class="n">roi_sdev_bk</span> <span class="o">=</span> <span class="n">peha</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">BKsdev</span>

            <span class="n">mean_bk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_mean_bk</span><span class="p">)</span>
            <span class="n">sdev_bk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_sdev_bk</span><span class="p">)</span>
            <span class="n">low_cnr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">roi_mean_s</span><span class="o">-</span><span class="n">roi_mean_bk</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">roi_sdev_s</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">roi_sdev_bk</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;mean fg/bk=&quot;</span><span class="p">,</span><span class="n">roi_mean_s</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="n">roi_mean_bk</span>
                <span class="k">print</span> <span class="s">&quot;sdev fg/bk=&quot;</span><span class="p">,</span><span class="n">roi_sdev_s</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="n">roi_sdev_bk</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">low_cnr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">low_cnr</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">mean_sg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mean_sg</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">mean_bk</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mean_bk</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">sdev_sg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sdev_sg</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">sdev_bk</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">low_cnr</span><span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">error</span>
<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.DICOMInfo"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.DICOMInfo">[docs]</a>    <span class="k">def</span> <span class="nf">DICOMInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;dicom&#39;</span><span class="p">):</span>
        <span class="c"># Different from ImageJ version; tags &quot;0008&quot;,&quot;0104&quot; and &quot;0054&quot;,&quot;0220&quot;</span>
        <span class="c">#  appear to be part of sequences. This gives problems (cannot be found</span>
        <span class="c">#  or returning whole sequence blocks)</span>
        <span class="c"># Possibly this can be solved by using if(type(value) == type(dicom.sequence.Sequence()))</span>
        <span class="c">#  but I don&#39;t see the relevance of these tags anymore, so set them to NO</span>

        <span class="k">if</span><span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="s">&quot;dicom&quot;</span><span class="p">):</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span>  <span class="s">&quot;SeriesDate&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,0031&quot;</span><span class="p">,</span>  <span class="s">&quot;SeriesTime&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,0070&quot;</span><span class="p">,</span>  <span class="s">&quot;Manufacturer&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,0080&quot;</span><span class="p">,</span>  <span class="s">&quot;InstitutionName&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,1010&quot;</span><span class="p">,</span>  <span class="s">&quot;StationName&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,1030&quot;</span><span class="p">,</span>  <span class="s">&quot;StudyDescription&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0010,0020&quot;</span><span class="p">,</span>  <span class="s">&quot;PatientID&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,0015&quot;</span><span class="p">,</span>  <span class="s">&quot;BodyPartExamined&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1000&quot;</span><span class="p">,</span>  <span class="s">&quot;DeviceSerialNumber&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1020&quot;</span><span class="p">,</span>  <span class="s">&quot;SoftwareVersions&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span>  <span class="s">&quot;ProtocolName&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0006&quot;</span><span class="p">,</span>  <span class="s">&quot;PlanarConfiguration&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0101&quot;</span><span class="p">,</span>  <span class="s">&quot;BitsStored&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0010&quot;</span><span class="p">,</span>  <span class="s">&quot;Rows&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0011&quot;</span><span class="p">,</span>  <span class="s">&quot;Columns&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="s">&quot;qc&quot;</span><span class="p">):</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span>  <span class="s">&quot;SeriesDate&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0008,0031&quot;</span><span class="p">,</span>  <span class="s">&quot;SeriesTime&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1000&quot;</span><span class="p">,</span>  <span class="s">&quot;DeviceSerialNumber&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1020&quot;</span><span class="p">,</span>  <span class="s">&quot;SoftwareVersions&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span>  <span class="s">&quot;ProtocolName&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0010&quot;</span><span class="p">,</span>  <span class="s">&quot;Rows&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;0028,0011&quot;</span><span class="p">,</span>  <span class="s">&quot;Columns&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dicomfields</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
<span class="c">#----------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="DDLQC.QC"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.QC">[docs]</a>    <span class="k">def</span> <span class="nf">QC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        all in one package!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outline:</span>
<span class="sd">        1. Determine grid scaling, rotation, location.</span>

<span class="sd">        step1: reorder such that UL,UR,LR,LL // was N, E, S W</span>
<span class="sd">        step2: travel straight along NS and find edge of x-ray; similar for EW</span>
<span class="sd">        step3: find horizontal uniformity</span>
<span class="sd">        step4: find Cu wedge stuff</span>
<span class="sd">        step5: find resolution stuff</span>
<span class="sd">        step6: low contrast stuff</span>
<span class="sd">        step7: put it in a report</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">error</span><span class="p">,</span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPhantomRotation</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;AlignROI(BoundingBox) &quot;</span>

        <span class="c"># 3: find horizontal uniformity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">verticalROI</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HorizontalUniformity</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;HorizontalUniformity &quot;</span>

        <span class="c"># 4: find Cu wedge stuff</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CuWedge</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span><span class="p">)</span>
<span class="c">#            error = self.CuWedgeFlat(cs,cs.po_roi)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;CuWedge &quot;</span>

        <span class="c"># 6: low contrast stuff</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LowContrast</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;LowContrast &quot;</span>

        <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">msg</span>
</div>
<div class="viewcode-block" id="DDLQC.ReportEntries"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.ReportEntries">[docs]</a>    <span class="k">def</span> <span class="nf">ReportEntries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to list all calculated items with names, only if cs completely filled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HorizontalOrVertical</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

        <span class="c">## Phantom orientation</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;PhantomOrientation&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">po_rot</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;PhantomAngle&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">po_angledeg</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;AlignConfidence&#39;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">bbox_confidence</span><span class="p">)</span> <span class="p">)</span>

        <span class="c">## uniformity</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;LineUniformity&#39;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">LineUniformity</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;LRUniformity&#39;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">LRuniformity</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;ROIUniformity&#39;</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">ROIuniformity</span><span class="p">)</span> <span class="p">)</span>

        <span class="c">## cuwedge</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;CuConfidence&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">wedge_confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="c"># Confidence in wedge finding</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;Cu0mean&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mean</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="c"># mean</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;Cu0sd&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_sdev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="c"># sdev</span>
        <span class="c"># SNR max</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;CuSNR_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_snr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="c"># CNR between steps all &gt; 1</span>
        <span class="n">minCNR</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">minCNR</span> <span class="o">=</span> <span class="nb">min</span> <span class="p">(</span><span class="n">minCNR</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_cnr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;CuCNRmin&#39;</span><span class="p">,</span><span class="n">minCNR</span><span class="p">)</span> <span class="p">)</span>
        <span class="c"># Dynamic Range</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;CuDR&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi_mmcu</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">dynamicRange</span><span class="p">)</span> <span class="p">)</span>
        <span class="c"># guesskVp</span>
        <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;guesskVp&#39;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">guesskVp</span><span class="p">)</span> <span class="p">)</span>

        <span class="c">## low contrast</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cnr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">low_cnr</span><span class="p">):</span>
            <span class="n">labvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;lowCNR_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">cnr</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">labvals</span>
</div>
<div class="viewcode-block" id="DDLQC.saveAnnotatedImage"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.saveAnnotatedImage">[docs]</a>    <span class="k">def</span> <span class="nf">saveAnnotatedImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">fname</span><span class="p">):</span>
        <span class="c"># make a palette, mapping intensities to greyscale</span>
        <span class="n">pal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
        <span class="c"># but reserve the first for red for markings</span>
        <span class="n">pal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># convert to 8-bit palette mapped image with lowest palette value used = 1</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">toimage</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pal</span><span class="o">=</span><span class="n">pal</span><span class="p">)</span> <span class="c"># MODULE EXPECTS PYQTGRAPH DATA: X AND Y ARE TRANSPOSED!</span>

        <span class="c"># now draw all rois in reserved color</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span><span class="p">)</span> <span class="c"># phantom orientation box</span>
        <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">unif</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span> <span class="c"># horizontal uniformity box</span>
        <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span> <span class="c"># Cu wedge box</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">cuwedge</span><span class="o">.</span><span class="n">step_rois</span><span class="p">:</span>
            <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c"># Cu wedge element</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">loco</span><span class="o">.</span><span class="n">lo_rois</span><span class="p">:</span>
            <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c"># low contrast element</span>

        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">roi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">+.</span><span class="mi">5</span><span class="p">)))</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span><span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">draw</span>

        <span class="c"># convert to RGB for JPG, cause JPG doesn&#39;t do PALETTE and PNG is much larger</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">)</span>

        <span class="n">imsi</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">imsi</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2048</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">2048.</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">imsi</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">imsi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ratio</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">imsi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ratio</span><span class="o">+.</span><span class="mi">5</span><span class="p">)),</span><span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DDLQC.checkPhantomRotation"><a class="viewcode-back" href="../../../../Plugin_development.Fluoro.Pehamed.html#Plugin_development.Fluoro.Pehamed.QCDDL_lib.DDLQC.checkPhantomRotation">[docs]</a>    <span class="k">def</span> <span class="nf">checkPhantomRotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ebbox</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concept: Try to find out if phantom is rotated over 90, 180 or 270 degrees (WKZ mostly)</span>
<span class="sd">        Workflow:</span>
<span class="sd">        1. Find center and orientation</span>
<span class="sd">        2. Find most likely location of CuWedge and LinePairs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c">#ang = 1</span>
        <span class="c">#cs.pixeldataIn = np.rot90(cs.pixeldataIn,ang)</span>

        <span class="c"># inversion</span>
        <span class="n">invertmax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invertmaxval</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

        <span class="c"># 1. Find center and orientation</span>
        <span class="n">ang0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findPhantomOrientation</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">ebbox</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">ang0</span> <span class="o">=</span> <span class="mi">180</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c"># try at 180 deg rotation</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findPhantomOrientation</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">ebbox</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="c">#cs.pixeldataIn = np.rot90(cs.pixeldataIn,2) # reset</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;NoOrientation &quot;</span>
                <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">msg</span>

        <span class="c"># 2. Make box at x-5cm and calculate avg</span>
        <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">po_roi</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">test_rois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">avgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># 1. Make box around wedge (-5.5; -4) to (+5.5; -5.5)</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">guessroom</span><span class="o">.</span><span class="n">phantom</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stWellhofer</span><span class="p">:</span> <span class="c"># WKZ</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">15.</span><span class="o">+</span><span class="mi">4</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">43.</span><span class="o">-</span><span class="mf">2.</span>
            <span class="n">x1</span> <span class="o">=</span>  <span class="mf">15.</span><span class="o">-</span><span class="mi">4</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">60.</span><span class="o">+</span><span class="mf">3.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bump</span> <span class="o">=</span> <span class="mf">2.</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">15.</span> <span class="o">+</span><span class="n">bump</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.</span> <span class="o">-</span><span class="n">bump</span>
            <span class="n">x1</span> <span class="o">=</span>  <span class="mf">15.</span> <span class="o">+</span><span class="n">bump</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">50.</span> <span class="o">-</span><span class="n">bump</span>

        <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[[</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],[</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]],</span> <span class="c"># S</span>
                 <span class="p">[[</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">],[</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">]],</span> <span class="c">#</span>
                 <span class="p">[[</span> <span class="n">x0</span><span class="p">,</span><span class="o">-</span><span class="n">y1</span><span class="p">],[</span> <span class="n">x1</span><span class="p">,</span><span class="o">-</span><span class="n">y0</span><span class="p">]],</span>
                 <span class="p">[[</span><span class="o">-</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">],[</span><span class="o">-</span><span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">]]</span>
                 <span class="p">]</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,(</span><span class="n">mmll</span><span class="p">,</span><span class="n">mmur</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lims</span><span class="p">):</span>
            <span class="n">xpxll</span><span class="p">,</span><span class="n">ypxll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">mmll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mmll</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># lowerlef</span>
            <span class="n">xpxur</span><span class="p">,</span><span class="n">ypxur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">mmur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mmur</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># upperright</span>
            <span class="n">xpxul</span><span class="p">,</span><span class="n">ypxul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">mmll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mmur</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># upperleft</span>
            <span class="n">xpxlr</span><span class="p">,</span><span class="n">ypxlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phantomposmm2pix</span><span class="p">(</span><span class="n">roipts_orig</span><span class="p">,</span><span class="n">mmur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mmll</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># lowerright</span>

            <span class="c"># box needs to be horizontal</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">xpxll</span><span class="p">,</span><span class="n">xpxul</span><span class="p">))</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">xpxlr</span><span class="p">,</span><span class="n">xpxur</span><span class="p">))</span>
            <span class="n">ylo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">ypxlr</span><span class="p">,</span><span class="n">ypxll</span><span class="p">))</span>
            <span class="n">yhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">ypxur</span><span class="p">,</span><span class="n">ypxul</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xhi</span> <span class="o">&lt;</span> <span class="n">xlo</span><span class="p">:</span>
                <span class="n">swap</span> <span class="o">=</span> <span class="n">xlo</span>
                <span class="n">xlo</span> <span class="o">=</span> <span class="n">xhi</span>
                <span class="n">xhi</span> <span class="o">=</span> <span class="n">swap</span>
            <span class="k">if</span> <span class="n">yhi</span> <span class="o">&lt;</span> <span class="n">ylo</span><span class="p">:</span>
                <span class="n">swap</span> <span class="o">=</span> <span class="n">ylo</span>
                <span class="n">ylo</span> <span class="o">=</span> <span class="n">yhi</span>
                <span class="n">yhi</span> <span class="o">=</span> <span class="n">swap</span>

            <span class="c"># 1. Make box around wedge (-5.5; -4) to (+5.5; -5.5)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">test_rois</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="p">[</span><span class="n">xlo</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">yhi</span><span class="p">],[</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">],[</span><span class="n">xlo</span><span class="p">,</span><span class="n">ylo</span><span class="p">]</span> <span class="p">])</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">mustbeinverted</span><span class="p">:</span>
                <span class="n">smallimage</span> <span class="o">=</span> <span class="n">invertmax</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smallimage</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">xlo</span><span class="p">:</span><span class="n">xhi</span><span class="p">,</span><span class="n">ylo</span><span class="p">:</span><span class="n">yhi</span><span class="p">]</span>

            <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">smallimage</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">ix</span><span class="p">,</span><span class="n">avg</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">avg</span><span class="o">/</span><span class="n">std</span>
            <span class="n">avgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>

        <span class="n">ang</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">po_rot</span> <span class="o">=</span> <span class="n">ang0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span> <span class="c"># pos was goed</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c"># pos +90rot</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c"># pos +180rot</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">stds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c"># pos +270rot</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># if heuristics did not work, make it more simple: cu-wedge should have smallest sd</span>
            <span class="n">min_stds</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span>
            <span class="n">min_index</span> <span class="o">=</span> <span class="n">stds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">min_stds</span><span class="p">)</span>            
            <span class="k">if</span> <span class="n">min_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># south, that&#39;s fine</span>
                <span class="n">ang</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">min_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># west</span>
                <span class="n">ang</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">min_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c"># north</span>
                <span class="n">ang</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ang</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c">#            print &quot;[checkPhantomRotation] ERROR! Cannot find orientation&quot;,avgs</span>
<span class="c">#            return True,&quot;NoOrientation &quot;</span>

        <span class="k">if</span> <span class="n">ang</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="o">-</span><span class="n">ang</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">po_rot</span> <span class="o">=</span> <span class="mi">90</span><span class="o">*</span><span class="n">ang</span><span class="o">+</span><span class="n">ang0</span>
        <span class="k">if</span> <span class="n">ang</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">ang0</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Rot&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">po_rot</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; &#39;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findPhantomOrientation</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">,</span><span class="n">msg</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>